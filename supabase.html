<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camarim - Sistema de Gestão</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    
    <!-- CDN do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #1a1a2e;
            --primary-dark: #1a1a2e;
            --secondary: #ff6b8b;
            --success: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            z-index: 100;
        }

        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left-color: var(--secondary);
            color: white;
            font-weight: 600;
        }

        .nav-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .quick-actions {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary, .btn-secondary {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            margin-bottom: 10px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #ff5252;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .header h2 {
            color: var(--dark);
            font-size: 1.8rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-info {
            background-color: #ff6b8b;
            color: white;
        }

        .btn-info:hover {
            background-color: #1a1a2e;
        }

        .btn-light {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #ddd;
        }

        .btn-light:hover {
            background-color: #e2e6ea;
        }

        /* Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .card-1 .card-icon {
            background-color: rgba(138, 43, 226, 0.1);
            color: var(--primary);
        }

        .card-2 .card-icon {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .card-3 .card-icon {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .card-4 .card-icon {
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--secondary);
        }

        .card h3 {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .card-change {
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        /* Tables */
        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--light);
        }

        th {
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: var(--dark);
            border-bottom: 2px solid var(--light-gray);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--light-gray);
            font-size: 16px;
            text-align: center;
        }

        tr:hover {
            background-color: rgba(138, 43, 226, 0.03);
        }

        .actions-cell {
            display: grid;
            gap: 4px;
        }

        /* Forms */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }

        .form-text {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .calculation-box {
            background-color: rgba(138, 43, 226, 0.05);
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .calculation-box h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }

        .calculation-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            border-bottom: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }

        /* Sale Cart */
        .cart-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .cart-items {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
        }

        .cart-summary {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            align-self: start;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info h4 {
            margin-bottom: 5px;
        }

        .cart-item-info .code {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background-color: var(--light);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #ddd;
        }

        .summary-row.total {
            font-weight: 700;
            font-size: 1.3rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 1080px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-large .modal-content {
            max-width: 800px;
        }

        .modal-header {
            padding: 30px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
            border-left: 4px solid #2196F3;
        }

        .alert-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        /* Charts */
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .chart-title {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 1.3rem;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px 0;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .nav-item {
                padding: 10px 15px;
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .nav-item.active {
                border-left: none;
                border-bottom-color: var(--secondary);
            }
            
            .quick-actions {
                display: none;
            }
            
            .cart-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Utilities */
        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .d-none {
            display: none;
        }

        .currency::before {
            content: 'R$ ';
        }

        .percentage::after {
            content: '%';
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }

        /* Pix QR Code */
        .pix-qr-code {
            text-align: center;
            margin: 20px 0;
        }

        .pix-qr-code canvas {
            max-width: 250px;
            height: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
        }

        .pix-copy-code {
            margin-top: 15px;
        }

        .pix-code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: var(--border-radius);
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 10px;
        }

        /* Receipt Styles */
        #receipt-content {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            font-family: 'Courier New', monospace;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .receipt-total {
            border-top: 2px solid #000;
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }

        /* Ajustes de altura para botões */
        #filter-products,
        #export-products,
        button[data-view="new-product"] {
            height: 36px !important;
            padding: 0.375rem 0.75rem !important;
            line-height: 1.5 !important;
            border-width: 1px !important;
        }

        /* Resumo de produtos */
        .products-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .products-summary .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }

        .products-summary .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .products-summary .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-right: 15px;
            background-color: rgba(138, 43, 226, 0.1);
            color: var(--primary);
        }

        .products-summary .card-title {
            font-size: 1rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .products-summary .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            margin: 5px 0;
        }

        .products-summary .card-subtitle {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .inventory-total-card .card-icon {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .inventory-cost-card .card-icon {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .inventory-margin-card .card-icon {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }

        .products-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .products-actions .left-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .products-actions .right-actions {
            display: flex;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .products-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .products-actions .left-actions,
            .products-actions .right-actions {
                width: 100%;
            }
            
            .products-actions .right-actions {
                justify-content: space-between;
            }
        }

        .logo-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            margin-bottom: 10px;
        }

        .logo-image {
            max-width: 150px;
            height: auto;
            display: block;
        }

        .logo-fallback {
            display: none; /* Escondido por padrão */
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .logo-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Se a imagem não carregar, mostrar o texto */
        .logo-image[src=""] + .logo-fallback,
        .logo-image:not([src]) + .logo-fallback {
            display: block;
        }

        /* Responsivo para telas menores */
        @media (max-width: 990px) {
            .logo-image {
                max-width: 120px;
            }
            
            .logo-container {
                min-height: 50px;
            }
        }

        @media (max-width: 760px) {
            .logo-image {
                max-width: 120px;
            }
        }

        /* Status de conexão */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
        }

        .connection-status.online {
            background-color: var(--success);
            color: white;
        }

        .connection-status.offline {
            background-color: var(--warning);
            color: white;
        }

        .connection-status.error {
            background-color: var(--danger);
            color: white;
        }

        /* Tela de login */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--gray);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .login-tab.active {
            color: var(--primary);
            border-bottom-color: var(--secondary);
        }

        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Tela de Login (inicialmente visível) -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <h2>Camarim Boutique</h2>
                <p>Sistema de Gestão em Nuvem</p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" data-tab="login">Login</button>
                <button class="login-tab" data-tab="signup">Nova Conta</button>
            </div>
            
            <div id="login-form-container">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="seu@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Senha</label>
                        <input type="password" id="login-password" class="form-control" placeholder="••••••••" required>
                    </div>
                    
                    <div class="alert alert-error d-none" id="login-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="login-error-message"></span>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
                
                <div class="login-footer">
                    <p>Use o mesmo email/senha em todos os dispositivos</p>
                    <p class="mt-10">
                        <button class="btn btn-light btn-small" id="offline-mode">
                            <i class="fas fa-desktop"></i> Modo Offline
                        </button>
                    </p>
                </div>
            </div>
            
            <div id="signup-form-container" class="d-none">
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-name">Nome</label>
                        <input type="text" id="signup-name" class="form-control" placeholder="Seu nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" class="form-control" placeholder="seu@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signup-password">Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="signup-password" class="form-control" placeholder="••••••••" minlength="6" required>
                    </div>
                    
                    <div class="alert alert-error d-none" id="signup-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="signup-error-message"></span>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-user-plus"></i> Criar Conta
                    </button>
                </form>
                
                <div class="login-footer">
                    <p>Sua conta será criada na nuvem</p>
                    <p>Você poderá acessar de qualquer dispositivo</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="main-system" class="container d-none">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-container">
                    <img src="logo-camarim.png" alt="CamarimLogo" class="logo-image">
                    <h1 class="logo-fallback">CAMARIM<span>.</span></h1>
                </div>
                <p class="logo-subtitle">Makeup & Skincare</p>
                <div id="user-info" style="margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                    <i class="fas fa-user"></i> <span id="user-email">Carregando...</span>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="#dashboard" class="nav-item active" data-view="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="#products" class="nav-item" data-view="products">
                    <i class="fas fa-boxes"></i> Produtos
                </a>
                <a href="#new-product" class="nav-item" data-view="new-product">
                    <i class="fas fa-plus-circle"></i> Cadastrar
                </a>
                <a href="#sales" class="nav-item" data-view="sales">
                    <i class="fas fa-shopping-cart"></i> Vendas
                </a>
                <a href="#new-sale" class="nav-item" data-view="new-sale">
                    <i class="fas fa-cash-register"></i> Nova Venda
                </a>
                <a href="#reports" class="nav-item" data-view="reports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </a>
                <a href="#settings" class="nav-item" data-view="settings">
                    <i class="fas fa-cog"></i> Configurações
                </a>
                <a href="#database" class="nav-item" data-view="database">
                    <i class="fas fa-database"></i> Nuvem
                </a>
            </nav>
            
            <div class="quick-actions">
                <a href="#new-sale" class="btn-primary" data-view="new-sale">
                    <i class="fas fa-cash-register"></i> Nova Venda
                </a>
                <a href="#new-product" class="btn-secondary" data-view="new-product">
                    <i class="fas fa-plus"></i> Novo Produto
                </a>
                <button class="btn btn-light btn-block mt-10" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header">
                <h2 id="page-title">Dashboard</h2>
                <div class="header-actions" id="header-actions">
                    <div id="sync-status" class="badge badge-info" style="padding: 8px 12px;">
                        <i class="fas fa-sync"></i> <span id="sync-text">Online</span>
                    </div>
                    <button class="btn btn-light" id="export-btn">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-info" id="import-btn">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
            </div>
            
            <div id="view-container">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <div class="dashboard-cards">
                        <div class="card card-1">
                            <div class="card-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <h3>Produtos Cadastrados</h3>
                            <div class="card-value" id="total-products">0</div>
                            <div class="card-change positive"></div>
                        </div>
                        
                        <div class="card card-2">
                            <div class="card-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <h3>Vendas Hoje</h3>
                            <div class="card-value" id="today-sales">0</div>
                            <div class="card-change positive"></div>
                        </div>
                        
                        <div class="card card-3">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3>Receita Mensal</h3>
                            <div class="card-value">
                                <span class="currency" id="monthly-revenue">0,00</span>
                            </div>
                            <div class="card-change positive"></div>
                        </div>
                        
                        <div class="card card-4">
                            <div class="card-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <h3>Produto Mais Vendido</h3>
                            <div class="card-value" id="best-seller">-</div>
                            <div class="card-change">
                                <span id="best-seller-qty">0</span> unidades vendidas
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">Vendas Mensais</h3>
                        <div class="chart-wrapper">
                            <canvas id="monthlySalesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h3 style="padding: 20px 20px 0;">Vendas Recentes</h3>
                        <table id="recent-sales-table">
                            <thead>
                                <tr>
                                    <th>ID Venda</th>
                                    <th>Data/Hora</th>
                                    <th>Produtos</th>
                                    <th>Total</th>
                                    <th>Atendente</th>
                                    <th>Pagamento</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sales-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Products View -->
                <div id="products-view" class="view d-none">
                    <div class="mb-20">
                        <div class="alert alert-success d-none" id="product-alert">
                            <i class="fas fa-check-circle"></i>
                            <span id="alert-message"></span>
                        </div>
                    </div>
                    
                    <div class="products-summary" id="inventory-summary"></div>
                    
                    <div class="products-actions">
                        <div class="left-actions">
                            <div class="form-group" style="min-width: 250px;">
                                <input type="text" class="form-control" id="product-search" placeholder="Buscar por nome ou código...">
                            </div>
                            <div class="form-group" style="width: 180px;">
                                <select class="form-control" id="category-filter">
                                    <option value="">Todas Categorias</option>
                                    <option value="Shoes">Sapatos</option>
                                    <option value="Belts">Cintos</option>
                                    <option value="Bags">Bolsas</option>
                                    <option value="Activewear">Roupas Esportivas</option>
                                    <option value="Clothing">Roupas Casuais</option>
                                    <option value="Makeup">Maquiagem</option>
                                    <option value="Skincare">Skincare</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="right-actions">
                            <button class="btn btn-success" id="export-products">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                            <button class="btn btn-primary" data-view="new-product">
                                <i class="fas fa-plus"></i> Novo Produto
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Custo</th>
                                    <th>CMV</th>
                                    <th>Markup</th>
                                    <th>Sugerido</th>
                                    <th>Preço</th>
                                    <th>Estoque</th>
                                    <th>Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="products-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- New Product View -->
                <div id="new-product-view" class="view d-none">
                    <div class="mb-20">
                        <div class="alert alert-success d-none" id="new-product-alert">
                            <i class="fas fa-check-circle"></i>
                            <span id="new-alert-message"></span>
                        </div>
                    </div>
                    
                    <div class="header">
                        <div class="header-actions">
                            <button class="btn btn-light" data-view="products">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <form id="product-form">
                            <input type="hidden" id="product-id">
                            <input type="hidden" id="is-edit" value="false">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="product-name">Nome do Produto *</label>
                                    <input type="text" id="product-name" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="product-category">Categoria *</label>
                                    <select id="product-category" class="form-control" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="Shoes">Sapatos</option>
                                        <option value="Belts">Cintos</option>
                                        <option value="Bags">Bolsas</option>
                                        <option value="Activewear">Roupas Esportivas</option>
                                        <option value="Clothing">Roupas Casuais</option>
                                        <option value="Makeup">Maquiagem</option>
                                        <option value="Skincare">Skincare</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="purchase-cost">Custo de Compra (R$) *</label>
                                    <input type="number" id="purchase-cost" class="form-control" step="0.01" min="0" required>
                                    <div class="form-text">Valor pago pelo produto</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="shipping-cost">Custo de Frete (R$) *</label>
                                    <input type="number" id="shipping-cost" class="form-control" step="0.01" min="0" required>
                                    <div class="form-text">Custo do frete para receber o produto</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="operational-expenses">Despesas Operacionais Mensais (R$)</label>
                                    <input type="number" id="operational-expenses" class="form-control" step="0.01" min="0" value="4000">
                                    <div class="form-text">Despesas fixas mensais da loja</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="expected-sales">Volume de Vendas Mensal Esperado *</label>
                                    <input type="number" id="expected-sales" class="form-control" min="1" required value="100">
                                    <div class="form-text">Quantidade esperada de vendas por mês</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="variable-fees">Taxas Variáveis (%)</label>
                                    <input type="number" id="variable-fees" class="form-control" step="0.1" min="0" value="9.5">
                                    <div class="form-text">Taxas de cartão + comissões (padrão: 9.5%)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="taxes">Impostos (%)</label>
                                    <input type="number" id="taxes" class="form-control" step="0.1" min="0" value="6">
                                    <div class="form-text">Impostos sobre a venda (padrão: 6%)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profit-margin">Margem de Lucro Desejada (%)</label>
                                    <input type="number" id="profit-margin" class="form-control" step="0.1" min="0" value="40">
                                    <div class="form-text">Margem de lucro desejada (padrão: 40%)</div>
                                </div>
                            </div>
                            
                            <div class="calculation-box">
                                <h4>Cálculo do Preço Sugerido</h4>
                                
                                <div class="calculation-row">
                                    <span>Custo de Compra:</span>
                                    <span id="calc-purchase-cost" class="currency">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span>+ Custo de Frete:</span>
                                    <span id="calc-shipping-cost" class="currency">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span>+ Custo Operacional Proporcional:</span>
                                    <span id="calc-operational-cost" class="currency">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span><strong>CMV (Custo Mercadoria Vendida):</strong></span>
                                    <span id="calc-cmv" class="currency"><strong>0,00</strong></span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span>Taxas Variáveis:</span>
                                    <span id="calc-variable-fees" class="percentage">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span>+ Impostos:</span>
                                    <span id="calc-taxes" class="percentage">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span>+ Margem de Lucro:</span>
                                    <span id="calc-profit-margin" class="percentage">0,00</span>
                                </div>
                                
                                <div class="calculation-row">
                                    <span><strong>Markup:</strong></span>
                                    <span id="calc-markup"><strong>0,00</strong></span>
                                </div>
                                
                                <div class="calculation-row total">
                                    <span>PREÇO SUGERIDO:</span>
                                    <span id="calc-suggested-price" class="currency"><strong>0,00</strong></span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="selling-price">Preço de Venda (R$) *</label>
                                    <input type="number" id="selling-price" class="form-control" step="0.01" min="0" required>
                                    <div class="form-text">Preço real de venda (pode ser ajustado)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="initial-stock">Estoque *</label>
                                    <input type="number" id="initial-stock" class="form-control" min="0" required value="10">
                                    <div class="form-text">Quantidade em estoque</div>
                                </div>
                            </div>
                            
                            <div class="text-right mt-20">
                                <button type="button" class="btn btn-light" data-view="products">Cancelar</button>
                                <button type="submit" class="btn btn-success" id="product-form-submit">Salvar Produto</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sales View -->
                <div id="sales-view" class="view d-none">
                    <div class="header">
                        <div class="header-actions">
                            <button class="btn btn-light" id="filter-sales">
                                <i class="fas fa-calendar-alt"></i> Filtrar por Data
                            </button>
                            <button class="btn btn-success" data-view="new-sale">
                                <i class="fas fa-cash-register"></i> Nova Venda
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="sales-table">
                            <thead>
                                <tr>
                                    <th>ID Venda</th>
                                    <th>Data/Hora</th>
                                    <th>Produtos</th>
                                    <th>Quantidade</th>
                                    <th>Total</th>
                                    <th>Atendente</th>
                                    <th>Pagamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="sales-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- New Sale View -->
                <div id="new-sale-view" class="view d-none">
                    <div class="header">
                        <div class="header-actions">
                            <button class="btn btn-light" data-view="sales">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                    </div>
                    
                    <div class="cart-container">
                        <div class="cart-items">
                            <h3 style="margin-bottom: 20px;">Produtos</h3>
                            
                            <div class="form-group mb-20">
                                <input type="text" class="form-control" id="sale-product-search" placeholder="Buscar produto por nome ou código...">
                            </div>
                            
                            <div id="sale-products-list"></div>
                            
                            <div id="sale-cart"></div>
                            
                            <div id="empty-cart-message" class="text-center" style="padding: 40px; color: var(--gray);">
                                <i class="fas fa-shopping-cart fa-3x mb-20"></i>
                                <h4>Carrinho vazio</h4>
                                <p>Adicione produtos usando a busca acima</p>
                            </div>
                        </div>
                        
                        <div class="cart-summary">
                            
                            <h3 style="margin-bottom: 20px;">Resumo da Venda</h3>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="attendant">Atendente *</label>
                                <select id="attendant" class="form-control" required>
                                    <option value="">Selecione o atendente</option>
                                    <option value="Gabryella">Gabryella</option>
                                    <option value="Guilherme">Guilherme</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="cart-subtotal" class="currency">0,00</span>
                            </div>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="sale-discount">Desconto (R$)</label>
                                <input type="number" id="sale-discount" class="form-control" step="0.01" min="0" value="0">
                            </div>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="payment-method">Método de Pagamento</label>
                                <select id="payment-method" class="form-control">
                                    <option value="cash">Dinheiro</option>
                                    <option value="pix">Pix</option>
                                    <option value="debit">Cartão de Débito</option>
                                    <option value="credit">Cartão de Crédito</option>
                                </select>
                            </div>
                            
                            <div class="form-group d-none" id="card-fee-container" style="margin: 15px 0;">
                                <label for="card-fee">Taxa do Cartão (%)</label>
                                    <input type="number" id="card-fee" class="form-control" step="0.1" min="0" value="3.5">
                                <div class="form-text" id="card-fee-info">Taxa para cartão de débito: 2% | Crédito: 4.5%</div>
                            </div>
                            
                            <div class="summary-row">
                                <span>Desconto:</span>
                                <span id="cart-discount" class="currency">0,00</span>
                            </div>
                            
                            <div class="summary-row d-none" id="cart-fees-row">
                                <span>Taxas:</span>
                                <span id="cart-fees" class="currency">0,00</span>
                            </div>
                            
                            <div class="summary-row total">
                                <span>TOTAL:</span>
                                <span id="cart-total" class="currency">0,00</span>
                            </div>
                            
                            <button class="btn btn-success btn-block" style="margin-top: 20px; padding: 15px;" id="complete-sale">
                                <i class="fas fa-check-circle"></i> Finalizar Venda
                            </button>
                            
                            <button class="btn btn-light btn-block" style="margin-top: 10px;" id="clear-cart">
                                <i class="fas fa-trash"></i> Limpar Carrinho
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Reports View -->
                <div id="reports-view" class="view d-none">
                    <div class="header">
                        <div class="header-actions">
                            <button class="btn btn-success" id="generate-pdf-report">
                                <i class="fas fa-file-pdf"></i> Gerar PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="card card-1">
                            <div class="card-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h3>Receita Total</h3>
                            <div class="card-value">
                                <span class="currency" id="report-revenue">0,00</span>
                            </div>
                            <div class="card-change">Últimos 30 dias</div>
                        </div>
                        
                        <div class="card card-2">
                            <div class="card-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <h3>Custo Total</h3>
                            <div class="card-value">
                                <span class="currency" id="report-cost">0,00</span>
                            </div>
                            <div class="card-change">Últimos 30 dias</div>
                        </div>
                        
                        <div class="card card-3">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3>Lucro Líquido</h3>
                            <div class="card-value">
                                <span class="currency" id="report-profit">0,00</span>
                            </div>
                            <div class="card-change positive"></div>
                        </div>
                        
                        <div class="card card-4">
                            <div class="card-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <h3>Produtos com Baixo Estoque</h3>
                            <div class="card-value" id="low-stock-count">0</div>
                            <div class="card-change">
                                <span id="low-stock-list"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">Desempenho por Categoria</h3>
                        <div class="chart-wrapper">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h3 style="padding: 20px 20px 0;">Top 10 Produtos Mais Vendidos</h3>
                        <table id="top-products-table">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Produto</th>
                                    <th>Categoria</th>
                                    <th>Quantidade Vendida</th>
                                    <th>Receita Gerada</th>
                                    <th>Lucro</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings View -->
                <div id="settings-view" class="view d-none">
                    <div class="header">
                        <button class="btn btn-light" data-view="dashboard">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                    
                    <div class="form-container">
                        <h3 style="margin-bottom: 20px;">Configurações Padrão</h3>
                        
                        <form id="settings-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="default-debit-fee">Taxa Cartão Débito (%)</label>
                                    <input type="number" id="default-debit-fee" class="form-control" step="0.1" min="0" value="2.0">
                                </div>
                                
                                <div class="form-group">
                                    <label for="default-credit-fee">Taxa Cartão Crédito (%)</label>
                                    <input type="number" id="default-credit-fee" class="form-control" step="0.1" min="0" value="4.5">
                                </div>
                                
                                <div class="form-group">
                                    <label for="default-tax">Imposto Padrão (%)</label>
                                    <input type="number" id="default-tax" class="form-control" step="0.1" min="0" value="6">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="default-margin">Margem de Lucro Padrão (%)</label>
                                    <input type="number" id="default-margin" class="form-control" step="0.1" min="0" value="40">
                                </div>
                                
                                <div class="form-group">
                                    <label for="monthly-expenses">Despesas Operacionais Mensais (R$)</label>
                                    <input type="number" id="monthly-expenses" class="form-control" step="0.01" min="0" value="4000">
                                </div>
                            </div>
                            
                            <h3 style="margin: 30px 0 20px;">Gerenciamento de Dados</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Exportar Dados</label>
                                    <button type="button" class="btn btn-info btn-block" id="export-data-btn">
                                        <i class="fas fa-download"></i> Exportar para JSON
                                    </button>
                                    <div class="form-text">Salve um backup de todos os dados do sistema</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Importar Dados</label>
                                    <button type="button" class="btn btn-warning btn-block" id="import-data-btn">
                                        <i class="fas fa-upload"></i> Importar de JSON
                                    </button>
                                    <div class="form-text">Restaurar dados a partir de um backup</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Limpar Dados</label>
                                    <button type="button" class="btn btn-danger btn-block" id="clear-data-btn">
                                        <i class="fas fa-trash"></i> Limpar Todos os Dados
                                    </button>
                                    <div class="form-text">Atenção: Esta ação não pode ser desfeita!</div>
                                </div>
                            </div>
                            
                            <div class="text-right mt-20">
                                <button type="submit" class="btn btn-success">Salvar Configurações</button>
                            </div>

                            <footer style="background-color: #fff; padding: 15px; margin-top: 30px; border-top: 1px solid #dee2e6;">
                                <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                                    <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">
                                        <strong style="color: #FF6B8B;">Camarim</strong>
                                        <span style="font-size: 1.1rem;">&copy;</span> 2025 - Sistema de Gestão desenvolvido por 
                                        <span style="color: #FF6B8B; font-weight: 500;">Guilherme Silva Vanderley</span> - Atualização: 23/12/25
                                    </p>
                                </div>
                            </footer>
                        </form>
                    </div>
                </div>
                
                <!-- Database View (agora chamada Nuvem) -->
                <div id="database-view" class="view d-none">
                    <div class="header">
                        <div class="header-actions">
                            <button class="btn btn-light" data-view="settings">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <div id="db-info-container" class="mb-20"></div>
                        
                        <div class="dashboard-cards">
                            <div class="card card-1">
                                <div class="card-icon">
                                    <i class="fas fa-cloud"></i>
                                </div>
                                <h3>Status da Nuvem</h3>
                                <div class="card-value" id="db-status">Carregando...</div>
                                <div class="card-change" id="db-type"></div>
                            </div>
                            
                            <div class="card card-2">
                                <div class="card-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <h3>Produtos</h3>
                                <div class="card-value" id="db-products">0</div>
                                <div class="card-change">Cadastrados</div>
                            </div>
                            
                            <div class="card card-3">
                                <div class="card-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <h3>Vendas</h3>
                                <div class="card-value" id="db-sales">0</div>
                                <div class="card-change">Registradas</div>
                            </div>
                            
                            <div class="card card-4">
                                <div class="card-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h3>Usuário</h3>
                                <div class="card-value" id="db-user">Carregando...</div>
                                <div class="card-change" id="db-email"></div>
                            </div>
                        </div>

                        <div class="mt-20">
                            <h3>Ações da Nuvem</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <button class="btn btn-info btn-block" id="migrate-local-data">
                                        <i class="fas fa-cloud-upload-alt"></i> Migrar para Nuvem
                                    </button>
                                    <div class="form-text">Migrar dados do localStorage para a nuvem</div>
                                </div>
                                
                                <div class="form-group">
                                    <button class="btn btn-success btn-block" id="create-backup">
                                        <i class="fas fa-save"></i> Criar Backup
                                    </button>
                                    <div class="form-text">Criar backup manual dos dados na nuvem</div>
                                </div>
                                
                                <div class="form-group">
                                    <button class="btn btn-warning btn-block" id="export-db">
                                        <i class="fas fa-download"></i> Exportar Dados
                                    </button>
                                    <div class="form-text">Exportar todos os dados para arquivo</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="backup-file">Importar Dados</label>
                                    <input type="file" id="backup-file" class="form-control" accept=".json">
                                    <button class="btn btn-primary btn-block mt-10" id="import-backup">
                                        <i class="fas fa-upload"></i> Importar Backup
                                    </button>
                                </div>
                                
                                <div class="form-group">
                                    <label for="cleanup-local">Limpeza Local</label>
                                    <button class="btn btn-danger btn-block" id="cleanup-local">
                                        <i class="fas fa-trash"></i> Limpar localStorage
                                    </button>
                                    <div class="form-text">Remove dados antigos do localStorage</div>
                                </div>
                            </div>
                            
                            <div class="alert alert-success d-none" id="db-alert">
                                <i class="fas fa-check-circle"></i>
                                <span id="db-alert-message"></span>
                            </div>
                            
                            <div class="alert alert-info mt-20">
                                <i class="fas fa-info-circle"></i>
                                <span>Sistema em nuvem: multiplataforma e acesso simultâneo</span>
                            </div>
                        </div>
                        
                        <footer style="background-color: #fff; padding: 15px; margin-top: 30px; border-top: 1px solid #dee2e6;">
                            <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                                <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">
                                    <strong style="color: #FF6B8B;">Camarim</strong>
                                    <span style="font-size: 1.1rem;">&copy;</span> 2025 - Sistema de Gestão desenvolvido por 
                                    <span style="color: #FF6B8B; font-weight: 500;">Guilherme Silva Vanderley</span> - Atualização: 23/12/25
                                </p>
                            </div>
                        </footer>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Status de conexão -->
    <div id="connection-status" class="connection-status d-none">
        <i class="fas fa-circle"></i>
        <span id="connection-text">Conectando...</span>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exportar Dados</h3>
                <button class="modal-close" data-modal="export-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Clique no botão abaixo para baixar um arquivo JSON com todos os dados do sistema.</p>
                <div class="form-group mt-20">
                    <label for="export-type">Tipo de Exportação:</label>
                    <select id="export-type" class="form-control">
                        <option value="all">Todos os Dados</option>
                        <option value="products">Apenas Produtos</option>
                        <option value="sales">Apenas Vendas</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="export-modal">Cancelar</button>
                <button class="btn btn-success" id="confirm-export">Exportar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importar Dados</h3>
                <button class="modal-close" data-modal="import-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecione um arquivo JSON para importar dados para o sistema.</p>
                <div class="form-group mt-20">
                    <label for="import-file">Arquivo JSON:</label>
                    <input type="file" id="import-file" class="form-control" accept=".json">
                </div>
                <div class="alert alert-error d-none" id="import-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="import-error-message"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="import-modal">Cancelar</button>
                <button class="btn btn-success" id="confirm-import">Importar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclusão</h3>
                <button class="modal-close" data-modal="delete-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-message">Tem certeza que deseja excluir este item?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="delete-modal">Cancelar</button>
                <button class="btn btn-danger" id="confirm-delete">Excluir</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="sale-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes da Venda</h3>
                <button class="modal-close" data-modal="sale-details-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="sale-details-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="sale-details-modal">Fechar</button>
                <button class="btn btn-success" id="print-receipt">
                    <i class="fas fa-print"></i> Imprimir Recibo
                </button>
            </div>
        </div>
    </div>
    
    <!-- Pix Modal -->
    <div class="modal" id="pix-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pagamento via Pix</h3>
                <button class="modal-close" data-modal="pix-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pix-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="pix-modal">Cancelar</button>
                <button class="btn btn-success" id="confirm-pix-payment">
                    <i class="fas fa-check"></i> Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div class="modal" id="receipt-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Recibo de Venda</h3>
                <button class="modal-close" data-modal="receipt-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receipt-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="receipt-modal">Fechar</button>
                <button class="btn btn-success" id="print-receipt-btn">
                    <i class="fas fa-print"></i> Imprimir Recibo
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report PDF Modal -->
    <div class="modal" id="pdf-report-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Gerar Relatório em PDF</h3>
                <button class="modal-close" data-modal="pdf-report-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <form id="pdf-report-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-type">Tipo de Relatório</label>
                                <select id="report-type" class="form-control" required>
                                    <option value="sales">Relatório de Vendas</option>
                                    <option value="products">Relatório de Produtos</option>
                                    <option value="financial">Relatório Financeiro</option>
                                    <option value="inventory">Relatório de Estoque</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="report-period">Período</label>
                                <select id="report-period" class="form-control" required>
                                    <option value="today">Hoje</option>
                                    <option value="yesterday">Ontem</option>
                                    <option value="last7">Últimos 7 dias</option>
                                    <option value="last30" selected>Últimos 30 dias</option>
                                    <option value="thisMonth">Este Mês</option>
                                    <option value="lastMonth">Mês Anterior</option>
                                    <option value="thisYear">Este Ano</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row d-none" id="custom-date-range">
                            <div class="form-group">
                                <label for="start-date">Data Inicial</label>
                                <input type="date" id="start-date" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="end-date">Data Final</label>
                                <input type="date" id="end-date" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-title">Título do Relatório</label>
                                <input type="text" id="report-title" class="form-control" placeholder="Ex: Relatório de Vendas - Janeiro 2024">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="include-charts">Incluir Gráficos</label>
                                <select id="include-charts" class="form-control">
                                    <option value="yes">Sim</option>
                                    <option value="no">Não</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="include-tables">Incluir Tabelas</label>
                                <select id="include-tables" class="form-control">
                                    <option value="yes">Sim</option>
                                    <option value="no">Não</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-format">Formato</label>
                                <select id="report-format" class="form-control">
                                    <option value="A4">A4 (Padrão)</option>
                                    <option value="A3">A3</option>
                                    <option value="letter">Carta</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="report-orientation">Orientação</label>
                                <select id="report-orientation" class="form-control">
                                    <option value="portrait">Retrato</option>
                                    <option value="landscape">Paisagem</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="alert alert-success d-none" id="pdf-report-alert">
                            <i class="fas fa-check-circle"></i>
                            <span id="pdf-report-message"></span>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="pdf-report-modal">Cancelar</button>
                <button class="btn btn-success" id="generate-pdf-btn">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Sale Modal -->
    <div class="modal" id="edit-sale-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Editar Venda</h3>
                <button class="modal-close" data-modal="edit-sale-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-sale-content">
                    <div class="cart-container">
                        <div class="cart-items">
                            <h3 style="margin-bottom: 20px;">Produtos</h3>
                            
                            <div class="form-group mb-20">
                                <input type="text" class="form-control" id="edit-sale-product-search" placeholder="Buscar produto por nome ou código...">
                            </div>
                            
                            <div id="edit-sale-products-list"></div>
                            
                            <div id="edit-sale-cart"></div>
                            
                            <div id="edit-empty-cart-message" class="text-center" style="padding: 40px; color: var(--gray);">
                                <i class="fas fa-shopping-cart fa-3x mb-20"></i>
                                <h4>Carrinho vazio</h4>
                                <p>Adicione produtos usando a busca acima</p>
                            </div>
                        </div>
                        
                        <div class="cart-summary">
                            <h3 style="margin-bottom: 20px;">Resumo da Venda</h3>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="edit-attendant">Atendente *</label>
                                <select id="edit-attendant" class="form-control" required>
                                    <option value="">Selecione o atendente</option>
                                    <option value="Gabryella">Gabryella</option>
                                    <option value="Guilherme">Guilherme</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="edit-cart-subtotal" class="currency">0,00</span>
                            </div>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="edit-sale-discount">Desconto (R$)</label>
                                <input type="number" id="edit-sale-discount" class="form-control" step="0.01" min="0" value="0">
                            </div>
                            
                            <div class="form-group" style="margin: 15px 0;">
                                <label for="edit-payment-method">Método de Pagamento</label>
                                <select id="edit-payment-method" class="form-control">
                                    <option value="cash">Dinheiro</option>
                                    <option value="pix">Pix</option>
                                    <option value="debit">Cartão de Débito</option>
                                    <option value="credit">Cartão de Crédito</option>
                                </select>
                            </div>
                            
                            <div class="form-group d-none" id="edit-card-fee-container" style="margin: 15px 0;">
                                <label for="edit-card-fee">Taxa do Cartão (%)</label>
                                <input type="number" id="edit-card-fee" class="form-control" step="0.1" min="0" value="3.5">
                                <div class="form-text" id="edit-card-fee-info">Taxa para cartão de débito: 2% | Crédito: 4.5%</div>
                            </div>
                            
                            <div class="summary-row">
                                <span>Desconto:</span>
                                <span id="edit-cart-discount" class="currency">0,00</span>
                            </div>
                            
                            <div class="summary-row d-none" id="edit-cart-fees-row">
                                <span>Taxas:</span>
                                <span id="edit-cart-fees" class="currency">0,00</span>
                            </div>
                            
                            <div class="summary-row total">
                                <span>TOTAL:</span>
                                <span id="edit-cart-total" class="currency">0,00</span>
                            </div>
                            
                            <div class="alert alert-warning mt-20">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Ao salvar as alterações, o estoque será ajustado automaticamente.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-modal="edit-sale-modal">Cancelar</button>
                <button class="btn btn-success" id="save-edited-sale">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-input" style="display: none;" accept=".json">
    
<!-- SUPABASE MANAGER SCRIPT COMPLETO -->
<script>
    // ============================================
    // SUPABASE MANAGER - Sistema de Nuvem
    // ============================================

    class SupabaseManager {
        constructor() {
            this.supabase = null;
            this.initialized = false;
            this.user = null;
            this.connectionStatus = 'offline';
            this.realtimeSubscriptions = [];
            
            // Configurações do Supabase (SUBSTITUA COM SUAS CREDENCIAIS)
            this.config = {
                url: 'https://wmwugjrcbkogzlyjxrdq.supabase.co', // SUBSTITUA
                key: 'sb_publishable_vvyI0BVe7UK1N-jSDNZrQQ_s6U7PJIR'       // SUBSTITUA
            };
        }

        // Inicializar Supabase
        async init() {
            try {
                console.log('🔌 Conectando ao Supabase...');
                
                // Carregar biblioteca Supabase se não existir
                if (typeof window.supabase === 'undefined') {
                    console.warn('⚠️ Biblioteca Supabase não carregada');
                    return false;
                }
                
                this.supabase = window.supabase.createClient(this.config.url, this.config.key);
                
                // Testar conexão
                const { data, error } = await this.supabase.from('_test_connection').select('count').limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    console.warn('⚠️ Supabase: Teste de conexão falhou, mas continuando...', error);
                }
                
                this.initialized = true;
                this.connectionStatus = 'online';
                console.log('✅ Supabase inicializado com sucesso');
                
                // Verificar se usuário já está logado
                await this.checkSession();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao inicializar Supabase:', error);
                this.connectionStatus = 'error';
                this.initialized = false;
                return false;
            }
        }

        // Verificar sessão existente
        async checkSession() {
            try {
                if (!this.supabase) return null;
                
                const { data: { user }, error } = await this.supabase.auth.getUser();
                
                if (error) {
                    console.log('👤 Nenhuma sessão ativa');
                    return null;
                }
                
                if (user) {
                    this.user = user;
                    console.log('✅ Sessão recuperada:', user.email);
                    return user;
                }
                
                return null;
                
            } catch (error) {
                console.error('❌ Erro ao verificar sessão:', error);
                return null;
            }
        }

        // ============================================
        // AUTENTICAÇÃO
        // ============================================

        async login(email, password) {
            try {
                showConnectionStatus('Conectando...', 'info');
                
                const { data, error } = await this.supabase.auth.signInWithPassword({
                    email: email.trim(),
                    password: password
                });

                if (error) throw error;

                this.user = data.user;
                this.connectionStatus = 'online';
                
                // Salvar informações localmente
                localStorage.setItem('camarim_user_email', this.user.email);
                localStorage.setItem('camarim_user_id', this.user.id);
                
                console.log('✅ Login realizado:', this.user.email);
                showConnectionStatus('Online', 'success');
                
                return {
                    success: true,
                    user: data.user
                };
                
            } catch (error) {
                console.error('❌ Erro no login:', error.message);
                showConnectionStatus('Erro de conexão', 'error');
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async signup(name, email, password) {
            try {
                showConnectionStatus('Criando conta...', 'info');
                
                const { data, error } = await this.supabase.auth.signUp({
                    email: email.trim(),
                    password: password,
                    options: {
                        data: {
                            name: name,
                            role: 'admin'
                        }
                    }
                });

                if (error) throw error;

                console.log('✅ Cadastro realizado:', email);
                showConnectionStatus('Conta criada! Verifique seu email.', 'success');
                
                return {
                    success: true,
                    message: 'Cadastro realizado! Verifique seu email para confirmar.',
                    user: data.user
                };
                
            } catch (error) {
                console.error('❌ Erro no cadastro:', error.message);
                showConnectionStatus('Erro ao criar conta', 'error');
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async logout() {
            try {
                // Cancelar todas as assinaturas em tempo real
                this.unsubscribeAll();
                
                const { error } = await this.supabase.auth.signOut();
                if (error) throw error;

                this.user = null;
                this.connectionStatus = 'offline';
                
                // Limpar localStorage
                localStorage.removeItem('camarim_user_email');
                localStorage.removeItem('camarim_user_id');
                
                console.log('✅ Logout realizado');
                showConnectionStatus('Offline', 'warning');
                
                return { success: true };
                
            } catch (error) {
                console.error('❌ Erro no logout:', error.message);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // ============================================
        // OPERAÇÕES DE DADOS
        // ============================================

        // PRODUTOS
        async getProducts(filters = {}) {
            try {
                let query = this.supabase
                    .from('products')
                    .select('*')
                    .eq('user_id', this.user.id)
                    .order('created_at', { ascending: false });

                // Aplicar filtros
                if (filters.category) {
                    query = query.eq('category', filters.category);
                }

                if (filters.search) {
                    query = query.or(`name.ilike.%${filters.search}%,id.ilike.%${filters.search}%`);
                }

                const { data, error } = await query;

                if (error) throw error;
                
                // Salvar cache local
                if (data && data.length > 0) {
                    localStorage.setItem(`camarim_cache_products_${this.user.id}`, JSON.stringify(data));
                }
                
                return data || [];
                
            } catch (error) {
                console.error('❌ Erro ao buscar produtos:', error);
                
                // Tentar cache local
                const cached = localStorage.getItem(`camarim_cache_products_${this.user.id}`);
                if (cached) {
                    console.log('📦 Usando cache local de produtos');
                    return JSON.parse(cached);
                }
                
                return [];
            }
        }

        async saveProduct(product) {
            try {
                const productData = {
                    ...product,
                    user_id: this.user.id,
                    updated_at: new Date().toISOString()
                };

                // Se não tem ID, é um novo produto
                if (!productData.id) {
                    productData.id = this.generateProductId();
                    productData.created_at = new Date().toISOString();
                }

                const { data, error } = await this.supabase
                    .from('products')
                    .upsert(productData)
                    .select()
                    .single();

                if (error) throw error;
                
                // Atualizar cache local
                this.updateProductCache(data);
                
                console.log('✅ Produto salvo na nuvem:', data.id);
                return { success: true, data };
                
            } catch (error) {
                console.error('❌ Erro ao salvar produto na nuvem:', error);
                
                // Salvar localmente em caso de erro
                product.user_id = this.user.id;
                product.offline = true;
                this.saveProductOffline(product);
                
                return { 
                    success: false, 
                    error: error.message,
                    offline: true 
                };
            }
        }

        async deleteProduct(id) {
            try {
                const { error } = await this.supabase
                    .from('products')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', this.user.id);

                if (error) throw error;
                
                // Remover do cache local
                this.removeProductFromCache(id);
                
                console.log('✅ Produto excluído da nuvem:', id);
                return { success: true };
                
            } catch (error) {
                console.error(`❌ Erro ao excluir produto ${id}:`, error);
                return { success: false, error: error.message };
            }
        }

        // VENDAS
        async getSales(filters = {}) {
            try {
                let query = this.supabase
                    .from('sales')
                    .select('*')
                    .eq('user_id', this.user.id)
                    .order('date', { ascending: false });

                // Aplicar filtros de data
                if (filters.startDate && filters.endDate) {
                    query = query.gte('date', filters.startDate)
                               .lte('date', filters.endDate);
                }

                const { data, error } = await query;

                if (error) throw error;
                
                // Salvar cache local
                if (data && data.length > 0) {
                    localStorage.setItem(`camarim_cache_sales_${this.user.id}`, JSON.stringify(data));
                }
                
                return data || [];
                
            } catch (error) {
                console.error('❌ Erro ao buscar vendas:', error);
                
                // Tentar cache local
                const cached = localStorage.getItem(`camarim_cache_sales_${this.user.id}`);
                if (cached) {
                    console.log('📦 Usando cache local de vendas');
                    return JSON.parse(cached);
                }
                
                return [];
            }
        }

        async saveSale(sale) {
            try {
                const saleData = {
                    ...sale,
                    user_id: this.user.id,
                    date: new Date().toISOString()
                };

                // Gerar ID se não existir
                if (!saleData.id) {
                    saleData.id = this.generateSaleId();
                }

                const { data, error } = await this.supabase
                    .from('sales')
                    .insert(saleData)
                    .select()
                    .single();

                if (error) throw error;
                
                // Atualizar cache local
                this.updateSaleCache(data);
                
                console.log('✅ Venda salva na nuvem:', data.id);
                return { success: true, data };
                
            } catch (error) {
                console.error('❌ Erro ao salvar venda na nuvem:', error);
                
                // Salvar localmente em caso de erro
                sale.user_id = this.user.id;
                sale.offline = true;
                this.saveSaleOffline(sale);
                
                return { 
                    success: false, 
                    error: error.message,
                    offline: true 
                };
            }
        }

        // CONFIGURAÇÕES
        async getSettings() {
            try {
                const { data, error } = await this.supabase
                    .from('settings')
                    .select('*')
                    .eq('user_id', this.user.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                // Se não existir, criar configurações padrão
                if (!data) {
                    const defaultSettings = this.getDefaultSettings();
                    await this.saveSettings(defaultSettings);
                    return defaultSettings;
                }

                return data;
                
            } catch (error) {
                console.error('❌ Erro ao buscar configurações:', error);
                return this.getDefaultSettings();
            }
        }

        async saveSettings(settings) {
            try {
                const settingsData = {
                    ...settings,
                    user_id: this.user.id,
                    last_updated: new Date().toISOString()
                };

                const { error } = await this.supabase
                    .from('settings')
                    .upsert(settingsData);

                if (error) throw error;
                
                console.log('✅ Configurações salvas na nuvem');
                return { success: true };
                
            } catch (error) {
                console.error('❌ Erro ao salvar configurações:', error);
                return { success: false, error: error.message };
                }
        }

        // ============================================
        // MIGRAÇÃO DE DADOS
        // ============================================

        async migrateLocalData() {
            if (!this.user) {
                throw new Error('Usuário não autenticado');
            }

            console.log('🚀 Iniciando migração de dados locais para nuvem...');
            showAlert('Migrando dados para a nuvem...', 'info');
            
            // Carregar dados do localStorage
            const localData = this.loadLocalData();
            
            if (!localData || (!localData.products && !localData.sales)) {
                return { 
                    success: false, 
                    message: 'Nenhum dado local encontrado para migrar' 
                };
            }

            const results = {
                products: { success: 0, failed: 0, total: 0 },
                sales: { success: 0, failed: 0, total: 0 },
                settings: { success: false }
            };

            try {
                // 1. Migrar produtos
                if (localData.products && localData.products.length > 0) {
                    results.products.total = localData.products.length;
                    
                    for (const product of localData.products) {
                        try {
                            const result = await this.saveProduct(product);
                            if (result.success) {
                                results.products.success++;
                            } else {
                                results.products.failed++;
                            }
                        } catch (error) {
                            results.products.failed++;
                        }
                    }
                }

                // 2. Migrar vendas
                if (localData.sales && localData.sales.length > 0) {
                    results.sales.total = localData.sales.length;
                    
                    for (const sale of localData.sales) {
                        try {
                            const result = await this.saveSale(sale);
                            if (result.success) {
                                results.sales.success++;
                            } else {
                                results.sales.failed++;
                            }
                        } catch (error) {
                            results.sales.failed++;
                        }
                    }
                }

                // 3. Migrar configurações
                if (localData.settings) {
                    await this.saveSettings(localData.settings);
                    results.settings.success = true;
                }

                // 4. Criar backup dos dados locais
                this.createMigrationBackup(localData);

                console.log('✅ Migração concluída:', results);
                
                const message = `Migração realizada: ${results.products.success}/${results.products.total} produtos, ${results.sales.success}/${results.sales.total} vendas`;
                showAlert(message, 'success');
                
                return {
                    success: true,
                    results: results,
                    message: message
                };

            } catch (error) {
                console.error('❌ Erro na migração:', error);
                showAlert('Erro na migração: ' + error.message, 'error');
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        loadLocalData() {
            try {
                const savedData = localStorage.getItem('camarim-system-data');
                if (savedData) {
                    return JSON.parse(savedData);
                }
                return null;
            } catch (error) {
                console.error('❌ Erro ao carregar dados locais:', error);
                return null;
            }
        }

        createMigrationBackup(data) {
            try {
                const backup = {
                    ...data,
                    backup_date: new Date().toISOString(),
                    migrated: true,
                    user_id: this.user.id
                };
                
                const backupStr = JSON.stringify(backup, null, 2);
                localStorage.setItem('camarim-backup-pre-migration', backupStr);
                
                console.log('💾 Backup de migração criado');
                
            } catch (error) {
                console.error('❌ Erro ao criar backup:', error);
            }
        }

        // ============================================
        // CACHE LOCAL
        // ============================================

        updateProductCache(product) {
            try {
                const cacheKey = `camarim_cache_products_${this.user.id}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    let products = JSON.parse(cached);
                    
                    // Encontrar e atualizar ou adicionar
                    const index = products.findIndex(p => p.id === product.id);
                    if (index !== -1) {
                        products[index] = product;
                    } else {
                        products.unshift(product);
                    }
                    
                    localStorage.setItem(cacheKey, JSON.stringify(products));
                }
            } catch (error) {
                console.error('❌ Erro ao atualizar cache:', error);
            }
        }

        removeProductFromCache(productId) {
            try {
                const cacheKey = `camarim_cache_products_${this.user.id}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    let products = JSON.parse(cached);
                    products = products.filter(p => p.id !== productId);
                    localStorage.setItem(cacheKey, JSON.stringify(products));
                }
            } catch (error) {
                console.error('❌ Erro ao remover do cache:', error);
            }
        }

        updateSaleCache(sale) {
            try {
                const cacheKey = `camarim_cache_sales_${this.user.id}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    let sales = JSON.parse(cached);
                    sales.unshift(sale);
                    
                    // Manter apenas as últimas 100 vendas no cache
                    if (sales.length > 100) {
                        sales = sales.slice(0, 100);
                    }
                    
                    localStorage.setItem(cacheKey, JSON.stringify(sales));
                }
            } catch (error) {
                console.error('❌ Erro ao atualizar cache de vendas:', error);
            }
        }

        saveProductOffline(product) {
            try {
                const offlineKey = `camarim_offline_products_${this.user.id}`;
                const offline = localStorage.getItem(offlineKey);
                let products = offline ? JSON.parse(offline) : [];
                
                products.push({
                    ...product,
                    offline_id: Date.now(),
                    pending_sync: true
                });
                
                localStorage.setItem(offlineKey, JSON.stringify(products));
                console.log('💾 Produto salvo offline:', product.id);
                
            } catch (error) {
                console.error('❌ Erro ao salvar offline:', error);
            }
        }

        saveSaleOffline(sale) {
            try {
                const offlineKey = `camarim_offline_sales_${this.user.id}`;
                const offline = localStorage.getItem(offlineKey);
                let sales = offline ? JSON.parse(offline) : [];
                
                sales.push({
                    ...sale,
                    offline_id: Date.now(),
                    pending_sync: true
                });
                
                localStorage.setItem(offlineKey, JSON.stringify(sales));
                console.log('💾 Venda salva offline:', sale.id);
                
            } catch (error) {
                console.error('❌ Erro ao salvar venda offline:', error);
            }
        }

        // ============================================
        // SINCRONIZAÇÃO EM TEMPO REAL
        // ============================================

        subscribeToChanges(callbacks) {
            if (!this.initialized || !this.user) {
                console.warn('⚠️ Não é possível assinar mudanças: Supabase não inicializado');
                return null;
            }

            try {
                console.log('📡 Assinando mudanças em tempo real...');
                
                // Canal para produtos
                const productsChannel = this.supabase
                    .channel('products-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'products',
                            filter: `user_id=eq.${this.user.id}`
                        },
                        (payload) => {
                            console.log('🔄 Mudança em produtos:', payload.eventType);
                            
                            // Atualizar cache local
                            if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                                this.updateProductCache(payload.new);
                            } else if (payload.eventType === 'DELETE') {
                                this.removeProductFromCache(payload.old.id);
                            }
                            
                            if (callbacks.onProductsChange) {
                                callbacks.onProductsChange(payload);
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log('📡 Status assinatura produtos:', status);
                    });

                this.realtimeSubscriptions.push(productsChannel);

                // Canal para vendas
                const salesChannel = this.supabase
                    .channel('sales-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'sales',
                            filter: `user_id=eq.${this.user.id}`
                        },
                        (payload) => {
                            console.log('🔄 Mudança em vendas:', payload.eventType);
                            
                            // Atualizar cache local
                            if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                                this.updateSaleCache(payload.new);
                            }
                            
                            if (callbacks.onSalesChange) {
                                callbacks.onSalesChange(payload);
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log('📡 Status assinatura vendas:', status);
                    });

                this.realtimeSubscriptions.push(salesChannel);

                console.log('✅ Assinaturas em tempo real ativas');
                
                return () => this.unsubscribeAll();
                
            } catch (error) {
                console.error('❌ Erro ao assinar mudanças:', error);
                return null;
            }
        }

        unsubscribeAll() {
            this.realtimeSubscriptions.forEach(channel => {
                if (this.supabase) {
                    this.supabase.removeChannel(channel);
                }
            });
            this.realtimeSubscriptions = [];
            console.log('📡 Todas as assinaturas canceladas');
        }

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================

        generateProductId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `CAM-${timestamp}-${random}`;
        }

        generateSaleId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `SALE-${timestamp}-${random}`;
        }

        getDefaultSettings() {
            return {
                defaultDebitFee: 2.0,
                defaultCreditFee: 4.5,
                defaultTax: 6,
                defaultMargin: 40,
                monthlyOperationalExpenses: 4000,
                lastProductId: 0,
                lastSaleId: 0
            };
        }

        async getDatabaseInfo() {
            try {
                if (!this.user) {
                    return {
                        status: 'Não autenticado',
                        products: 0,
                        sales: 0,
                        user: 'Não logado'
                    };
                }

                // Contar produtos
                const { count: productsCount, error: productsError } = await this.supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', this.user.id);

                // Contar vendas
                const { count: salesCount, error: salesError } = await this.supabase
                    .from('sales')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', this.user.id);

                const status = this.connectionStatus === 'online' ? 'Online' : 'Offline';
                
                return {
                    status: status,
                    products: productsCount || 0,
                    sales: salesCount || 0,
                    user: this.user.email,
                    user_id: this.user.id.substring(0, 8) + '...'
                };
                
            } catch (error) {
                console.error('❌ Erro ao buscar info do banco:', error);
                return {
                    status: 'Erro',
                    products: 0,
                    sales: 0,
                    user: this.user ? this.user.email : 'Não logado'
                };
            }
        }

        async exportAllData() {
            try {
                const [products, sales, settings] = await Promise.all([
                    this.getProducts(),
                    this.getSales(),
                    this.getSettings()
                ]);

                const exportData = {
                    products,
                    sales,
                    settings,
                    exported_at: new Date().toISOString(),
                    user_id: this.user.id,
                    user_email: this.user.email
                };

                return {
                    success: true,
                    data: exportData
                };
                
            } catch (error) {
                console.error('❌ Erro ao exportar dados:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async syncOfflineData() {
            if (!this.user) return { success: false, message: 'Usuário não autenticado' };
            
            console.log('🔄 Sincronizando dados offline...');
            showAlert('Sincronizando dados offline...', 'info');
            
            let syncedProducts = 0;
            let syncedSales = 0;
            
            try {
                // Sincronizar produtos offline
                const offlineProductsKey = `camarim_offline_products_${this.user.id}`;
                const offlineProducts = localStorage.getItem(offlineProductsKey);
                
                if (offlineProducts) {
                    const products = JSON.parse(offlineProducts);
                    const pendingProducts = products.filter(p => p.pending_sync);
                    
                    for (const product of pendingProducts) {
                        const { success } = await this.saveProduct(product);
                        if (success) {
                            syncedProducts++;
                            product.pending_sync = false;
                        }
                    }
                    
                    // Atualizar storage
                    localStorage.setItem(offlineProductsKey, JSON.stringify(products.filter(p => p.pending_sync)));
                }
                
                // Sincronizar vendas offline
                const offlineSalesKey = `camarim_offline_sales_${this.user.id}`;
                const offlineSales = localStorage.getItem(offlineSalesKey);
                
                if (offlineSales) {
                    const sales = JSON.parse(offlineSales);
                    const pendingSales = sales.filter(s => s.pending_sync);
                    
                    for (const sale of pendingSales) {
                        const { success } = await this.saveSale(sale);
                        if (success) {
                            syncedSales++;
                            sale.pending_sync = false;
                        }
                    }
                    
                    // Atualizar storage
                    localStorage.setItem(offlineSalesKey, JSON.stringify(sales.filter(s => s.pending_sync)));
                }
                
                const message = `Sincronização concluída: ${syncedProducts} produtos, ${syncedSales} vendas`;
                console.log('✅', message);
                showAlert(message, 'success');
                
                return {
                    success: true,
                    syncedProducts,
                    syncedSales
                };
                
            } catch (error) {
                console.error('❌ Erro na sincronização offline:', error);
                showAlert('Erro na sincronização: ' + error.message, 'error');
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }
    }

    // ============================================
    // GLOBAL SUPABASE MANAGER INSTANCE
    // ============================================

    const supabaseManager = new SupabaseManager();

    // ============================================
    // FUNÇÕES DO SISTEMA PRINCIPAL
    // ============================================

    // Estado da aplicação
    let systemData = {
        products: [],
        sales: [],
        settings: {}
    };

    let appState = {
        currentView: 'dashboard',
        currentProductId: null,
        currentSaleId: null,
        cart: [],
        saleInProgress: false,
        charts: {
            monthlySales: null,
            categoryChart: null
        },
        currentSaleData: null,
        databaseReady: false,
        useSupabase: false
    };

    // Dados para edição de vendas
    let editingSaleData = {
        saleId: null,
        originalSale: null,
        cart: [],
        originalCart: []
    };

    // ============================================
    // FALLBACK DATABASE MANAGER (Modo Local)
    // ============================================

    class LocalDatabaseManager {
        constructor() {
            this.data = null;
            this.isLocal = true;
        }

        async load() {
            try {
                const saved = localStorage.getItem('camarim-system-data');
                this.data = saved ? JSON.parse(saved) : {
                    products: [],
                    sales: [],
                    settings: {
                        defaultDebitFee: 2.0,
                        defaultCreditFee: 4.5,
                        defaultTax: 6,
                        defaultMargin: 40,
                        monthlyOperationalExpenses: 4000,
                        lastProductId: 0,
                        lastSaleId: 0
                    }
                };
                return this.data;
            } catch (error) {
                console.error('❌ Erro ao carregar dados locais:', error);
                return this.data;
            }
        }

        async save() {
            try {
                localStorage.setItem('camarim-system-data', JSON.stringify(this.data));
                return true;
            } catch (error) {
                console.error('❌ Erro ao salvar dados locais:', error);
                return false;
            }
        }

        async getProducts() {
            return this.data.products || [];
        }

        async saveProduct(product) {
            if (!product.id) {
                product.id = 'LOCAL-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                product.created_at = new Date().toISOString();
            }
            
            product.updated_at = new Date().toISOString();
            
            const index = this.data.products.findIndex(p => p.id === product.id);
            if (index !== -1) {
                this.data.products[index] = product;
            } else {
                this.data.products.unshift(product);
            }
            
            await this.save();
            return { success: true, data: product };
        }

        async deleteProduct(id) {
            this.data.products = this.data.products.filter(p => p.id !== id);
            await this.save();
            return { success: true };
        }

        async getSales() {
            return this.data.sales || [];
        }

        async saveSale(sale) {
            if (!sale.id) {
                sale.id = 'SALE-LOCAL-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                sale.date = new Date().toISOString();
            }
            
            this.data.sales.unshift(sale);
            await this.save();
            return { success: true, data: sale };
        }

        async getSettings() {
            return this.data.settings || {};
        }

        async saveSettings(settings) {
            this.data.settings = { ...this.data.settings, ...settings };
            await this.save();
            return { success: true };
        }
    }

    const localDatabaseManager = new LocalDatabaseManager();

    // ============================================
    // INICIALIZAÇÃO DO SISTEMA
    // ============================================

    async function initializeSystem() {
        console.log('🚀 Inicializando Sistema Camarim...');
        
        // Mostrar tela de login inicialmente
        showLoginScreen();
        
        // Configurar event listeners da tela de login
        setupLoginEvents();
        
        // Tentar conectar ao Supabase
        const supabaseConnected = await supabaseManager.init();
        
        if (supabaseConnected) {
            console.log('✅ Supabase disponível');
            appState.useSupabase = true;
            
            // Verificar se já tem sessão
            const user = await supabaseManager.checkSession();
            if (user) {
                // Usuário já está logado, entrar automaticamente
                await handleSuccessfulLogin(user);
                return;
            }
        } else {
            console.log('⚠️ Supabase não disponível, usando modo offline');
            appState.useSupabase = false;
            showAlert('Modo offline ativado. Os dados serão salvos apenas neste dispositivo.', 'warning');
            
            // Esconder opções de nuvem
            const dbView = document.querySelector('[data-view="database"]');
            if (dbView) {
                dbView.style.display = 'none';
            }
        }
        
        // Se chegou aqui, mostrar tela de login
        document.getElementById('login-screen').classList.remove('d-none');
    }

    function showLoginScreen() {
        document.getElementById('login-screen').classList.remove('d-none');
        document.getElementById('main-system').classList.add('d-none');
        document.getElementById('connection-status').classList.add('d-none');
    }

    function showMainSystem() {
        document.getElementById('login-screen').classList.add('d-none');
        document.getElementById('main-system').classList.remove('d-none');
        document.getElementById('connection-status').classList.remove('d-none');
        
        // Atualizar info do usuário
        if (supabaseManager.user) {
            const userEmailEl = document.getElementById('user-email');
            if (userEmailEl) {
                userEmailEl.textContent = supabaseManager.user.email;
            }
        }
    }

    function setupLoginEvents() {
        // Tabs login/cadastro
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Ativar tab
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar form correspondente
                if (tabName === 'login') {
                    document.getElementById('login-form-container').classList.remove('d-none');
                    document.getElementById('signup-form-container').classList.add('d-none');
                } else {
                    document.getElementById('login-form-container').classList.add('d-none');
                    document.getElementById('signup-form-container').classList.remove('d-none');
                }
            });
        });
        
        // Formulário de login
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showLoginError('Preencha todos os campos');
                return;
            }
            
            showLoginError(''); // Limpar erro anterior
            
            const result = await supabaseManager.login(email, password);
            
            if (result.success) {
                await handleSuccessfulLogin(result.user);
            } else {
                showLoginError(result.error || 'Erro ao fazer login');
            }
        });
        
        // Formulário de cadastro
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!name || !email || !password) {
                showSignupError('Preencha todos os campos');
                return;
            }
            
            if (password.length < 6) {
                showSignupError('A senha deve ter pelo menos 6 caracteres');
                return;
            }
            
            showSignupError(''); // Limpar erro anterior
            
            const result = await supabaseManager.signup(name, email, password);
            
            if (result.success) {
                showSignupError('✅ Conta criada! Verifique seu email e faça login.');
                
                // Voltar para tela de login após 3 segundos
                setTimeout(() => {
                    const loginTab = document.querySelector('.login-tab[data-tab="login"]');
                    if (loginTab) {
                        loginTab.click();
                    }
                    document.getElementById('login-email').value = email;
                }, 3000);
            } else {
                showSignupError(result.error || 'Erro ao criar conta');
            }
        });
        
        // Botão modo offline
        const offlineModeBtn = document.getElementById('offline-mode');
        if (offlineModeBtn) {
            offlineModeBtn.addEventListener('click', function() {
                if (confirm('Modo offline: Os dados serão salvos apenas neste dispositivo. Continuar?')) {
                    appState.useSupabase = false;
                    startOfflineMode();
                }
            });
        }
        
        // Botão logout no sistema principal
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                if (appState.useSupabase) {
                    await supabaseManager.logout();
                }
                showLoginScreen();
            });
        }
    }

    function showLoginError(message) {
        const errorEl = document.getElementById('login-error');
        const messageEl = document.getElementById('login-error-message');
        
        if (errorEl && messageEl) {
            if (message) {
                errorEl.classList.remove('d-none');
                messageEl.textContent = message;
            } else {
                errorEl.classList.add('d-none');
            }
        }
    }

    function showSignupError(message) {
        const errorEl = document.getElementById('signup-error');
        const messageEl = document.getElementById('signup-error-message');
        
        if (errorEl && messageEl) {
            if (message) {
                errorEl.classList.remove('d-none');
                messageEl.textContent = message;
            } else {
                errorEl.classList.add('d-none');
            }
        }
    }

    async function handleSuccessfulLogin(user) {
        console.log('✅ Login bem-sucedido:', user.email);
        
        appState.useSupabase = true;
        
        // Mostrar sistema principal
        showMainSystem();
        
        // Inicializar sistema com dados da nuvem
        await initSystem();
        setupEventListeners();
        checkHashAndShowView();
        
        // Configurar sincronização em tempo real
        setupRealtimeSync();
        
        // Mostrar status de conexão
        showConnectionStatus('Online', 'success');
        
        // Tentar sincronizar dados offline pendentes
        setTimeout(() => {
            supabaseManager.syncOfflineData();
        }, 2000);
    }

    function startOfflineMode() {
        console.log('📴 Iniciando modo offline');
        
        appState.useSupabase = false;
        showMainSystem();
        
        // Inicializar sistema offline
        initSystem();
        setupEventListeners();
        checkHashAndShowView();
        
        showAlert('Modo offline ativado. Os dados serão salvos apenas neste dispositivo.', 'warning');
        showConnectionStatus('Offline', 'warning');
        
        // Esconder opções de nuvem
        const dbView = document.querySelector('[data-view="database"]');
        if (dbView) {
            dbView.style.display = 'none';
        }
    }

    function showConnectionStatus(text, type) {
        const statusEl = document.getElementById('connection-status');
        const textEl = document.getElementById('connection-text');
        
        if (statusEl && textEl) {
            statusEl.classList.remove('d-none', 'online', 'offline', 'error', 'info');
            statusEl.classList.add(type);
            textEl.textContent = text;
            
            // Atualizar também no header
            const syncEl = document.getElementById('sync-status');
            const syncText = document.getElementById('sync-text');
            
            if (syncEl && syncText) {
                syncEl.className = `badge badge-${type === 'success' ? 'info' : type === 'warning' ? 'warning' : 'danger'}`;
                syncText.textContent = text;
            }
        }
    }

    function setupRealtimeSync() {
        if (!appState.useSupabase || !supabaseManager.user) return;
        
        const unsubscribe = supabaseManager.subscribeToChanges({
            onProductsChange: (payload) => {
                console.log('🔄 Produto atualizado remotamente:', payload.eventType);
                showAlert('Dados atualizados em tempo real', 'info');
                
                // Atualizar views
                updateProductsList();
                updateInventorySummary();
                
                if (appState.currentView === 'dashboard') {
                    updateDashboard();
                }
            },
            onSalesChange: (payload) => {
                console.log('🔄 Venda atualizada remotamente:', payload.eventType);
                showAlert('Venda registrada em tempo real', 'info');
                
                // Atualizar views
                updateSalesList();
                updateDashboard();
                
                if (appState.currentView === 'reports') {
                    updateReports();
                }
            }
        });
        
        // Salvar função para limpar ao sair
        window.supabaseUnsubscribe = unsubscribe;
    }

    // ============================================
    // FUNÇÕES PRINCIPAIS DO SISTEMA
    // ============================================

    async function initSystem() {
        console.log('🔄 Carregando dados do sistema...');
        
        try {
            if (appState.useSupabase && supabaseManager.user) {
                // Carregar da nuvem
                console.log('☁️ Carregando dados da nuvem...');
                
                const [products, sales, settings] = await Promise.all([
                    supabaseManager.getProducts(),
                    supabaseManager.getSales(),
                    supabaseManager.getSettings()
                ]);
                
                systemData = {
                    products: products || [],
                    sales: sales || [],
                    settings: settings || supabaseManager.getDefaultSettings()
                };
                
                console.log(`✅ Dados da nuvem carregados: ${systemData.products.length} produtos, ${systemData.sales.length} vendas`);
                
            } else {
                // Carregar localmente
                console.log('💻 Carregando dados locais...');
                loadFromLocalStorageDirect();
            }
            
            // Carregar configurações na UI
            loadData();
            updateDashboard();
            appState.databaseReady = true;
            
        } catch (error) {
            console.error('❌ Erro ao inicializar sistema:', error);
            showAlert('Erro ao carregar dados. Usando dados locais.', 'warning');
            loadFromLocalStorageDirect();
        }
    }

    async function saveData() {
        try {
            if (appState.useSupabase && supabaseManager.user) {
                // Salvar na nuvem
                const dataToSave = {
                    products: systemData.products,
                    sales: systemData.sales,
                    settings: systemData.settings
                };
                
                // Salvar cada produto individualmente (para sincronização em tempo real)
                for (const product of systemData.products) {
                    await supabaseManager.saveProduct(product);
                }
                
                // Salvar cada venda
                for (const sale of systemData.sales) {
                    await supabaseManager.saveSale(sale);
                }
                
                // Salvar configurações
                await supabaseManager.saveSettings(systemData.settings);
                
                console.log('💾 Dados salvos na nuvem');
                
            } else {
                // Salvar localmente
                localStorage.setItem('camarim-system-data', JSON.stringify(systemData));
                console.log('💾 Dados salvos localmente');
            }
            
            return true;
            
        } catch (error) {
            console.error('❌ Erro ao salvar dados:', error);
            showAlert('Erro ao salvar dados', 'error');
            return false;
        }
    }

    // ============================================
    // FUNÇÕES DE FORMATAÇÃO
    // ============================================

    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) {
            return 'R$ 0,00';
        }
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Number(value));
    }

    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) {
            return '0';
        }
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(Number(value));
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function sanitizeNumber(value) {
        if (typeof value === 'string') {
            // Remove tudo exceto números, ponto e vírgula
            value = value.replace(/[^\d,.-]/g, '');
            // Substitui vírgula por ponto
            value = value.replace(',', '.');
        }
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    function getCategoryName(category) {
        const categories = {
            'blusa': 'Blusa',
            'camisa': 'Camisa',
            'camiseta': 'Camiseta',
            'calca': 'Calça',
            'short': 'Short',
            'saia': 'Saia',
            'vestido': 'Vestido',
            'casaco': 'Casaco',
            'jaqueta': 'Jaqueta',
            'moletom': 'Moletom',
            'bermuda': 'Bermuda',
            'macacao': 'Macacão',
            'body': 'Body',
            'pijama': 'Pijama',
            'roupa_intima': 'Roupa Íntima',
            'meia': 'Meia',
            'acessorio': 'Acessório',
            'calcado': 'Calçado',
            'outro': 'Outro'
        };
        return categories[category] || category;
    }

    // ============================================
    // FUNÇÕES DE CARREGAMENTO
    // ============================================

    function loadFromLocalStorageDirect() {
        try {
            const savedData = localStorage.getItem('camarim-system-data');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                systemData = {
                    products: parsed.products || [],
                    sales: parsed.sales || [],
                    settings: parsed.settings || {
                        defaultDebitFee: 2.0,
                        defaultCreditFee: 4.5,
                        defaultTax: 6,
                        defaultMargin: 40,
                        monthlyOperationalExpenses: 4000,
                        lastProductId: 0,
                        lastSaleId: 0
                    }
                };
                console.log('✅ Dados locais carregados');
            }
        } catch (error) {
            console.error('❌ Erro ao carregar dados locais:', error);
            systemData = {
                products: [],
                sales: [],
                settings: {
                    defaultDebitFee: 2.0,
                    defaultCreditFee: 4.5,
                    defaultTax: 6,
                    defaultMargin: 40,
                    monthlyOperationalExpenses: 4000,
                    lastProductId: 0,
                    lastSaleId: 0
                }
            };
        }
    }

    function loadData() {
        // Carrega dados do estado atual
        updateProductsList();
        updateSalesList();
        loadSettingsToForm();
        updateDashboard();
    }

    // ============================================
    // NAVEGAÇÃO ENTRE VIEWS
    // ============================================

    function checkHashAndShowView() {
        const hash = window.location.hash.substring(1) || 'dashboard';
        showView(hash);
    }

    function showView(viewName) {
        // Esconder todas as views
        document.querySelectorAll('.view').forEach(view => {
            view.classList.add('d-none');
        });
        
        // Remover active de todos os links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Mostrar view solicitada
        const viewElement = document.querySelector(`[data-view="${viewName}"]`);
        if (viewElement) {
            viewElement.classList.remove('d-none');
            
            // Ativar link correspondente
            const link = document.querySelector(`[href="#${viewName}"]`);
            if (link) {
                link.classList.add('active');
            }
            
            // Executar funções específicas da view
            switch (viewName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'inventory':
                    updateProductsList();
                    updateInventorySummary();
                    break;
                case 'sales':
                    updateSalesList();
                    break;
                case 'reports':
                    updateReports();
                    break;
                case 'database':
                    updateDatabaseInfo();
                    break;
                case 'settings':
                    loadSettingsToForm();
                    break;
            }
            
            // Atualizar estado atual
            appState.currentView = viewName;
        }
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            
            // Adicionar backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
            
            // Prevenir scroll no body
            document.body.style.overflow = 'hidden';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            
            // Remover backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            
            // Restaurar scroll
            document.body.style.overflow = '';
        }
    }

    function showProductModal(product = null) {
        const modal = document.getElementById('product-modal');
        const title = document.getElementById('product-modal-title');
        const form = document.getElementById('product-form');
        
        if (!modal || !title || !form) return;
        
        if (product) {
            // Modo edição
            title.textContent = 'Editar Produto';
            appState.currentProductId = product.id;
            
            // Preencher formulário
            document.getElementById('product-id').value = product.id || '';
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-cost').value = product.cost || '';
            document.getElementById('product-price').value = product.price || '';
            document.getElementById('product-stock').value = product.stock || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-supplier').value = product.supplier || '';
            document.getElementById('product-sku').value = product.sku || '';
            document.getElementById('product-barcode').value = product.barcode || '';
            document.getElementById('product-min-stock').value = product.min_stock || '';
            document.getElementById('product-max-stock').value = product.max_stock || '';
            document.getElementById('product-location').value = product.location || '';
            
            // Botão excluir
            const deleteBtn = document.getElementById('delete-product-btn');
            if (deleteBtn) {
                deleteBtn.classList.remove('d-none');
            }
        } else {
            // Modo novo produto
            title.textContent = 'Novo Produto';
            appState.currentProductId = null;
            
            // Limpar formulário
            form.reset();
            document.getElementById('product-id').value = '';
            
            // Esconder botão excluir
            const deleteBtn = document.getElementById('delete-product-btn');
            if (deleteBtn) {
                deleteBtn.classList.add('d-none');
            }
        }
        
        showModal('product-modal');
    }

    // ============================================
    // FUNÇÕES PARA NUVEM
    // ============================================

    async function updateDatabaseInfo() {
        const container = document.getElementById('db-info-container');
        if (!container) return;
        
        if (appState.useSupabase && supabaseManager.user) {
            const info = await supabaseManager.getDatabaseInfo();
            
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-cloud"></i>
                    <strong>Sistema em Nuvem</strong>
                    <p>Usuário: ${info.user} | Status: ${info.status}</p>
                    <p>Produtos: ${info.products} | Vendas: ${info.sales}</p>
                </div>
            `;
            
            // Atualizar cards
            const dbStatus = document.getElementById('db-status');
            const dbType = document.getElementById('db-type');
            const dbProducts = document.getElementById('db-products');
            const dbSales = document.getElementById('db-sales');
            const dbUser = document.getElementById('db-user');
            const dbEmail = document.getElementById('db-email');
            
            if (dbStatus) dbStatus.textContent = info.status;
            if (dbType) dbType.textContent = 'Supabase';
            if (dbProducts) dbProducts.textContent = info.products;
            if (dbSales) dbSales.textContent = info.sales;
            if (dbUser) dbUser.textContent = info.user.split('@')[0];
            if (dbEmail) dbEmail.textContent = info.user;
            
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-desktop"></i>
                    <strong>Modo Offline</strong>
                    <p>Os dados estão sendo salvos apenas neste dispositivo.</p>
                    <p>Para acessar de múltiplos dispositivos, faça login na nuvem.</p>
                </div>
            `;
            
            const dbStatus = document.getElementById('db-status');
            const dbType = document.getElementById('db-type');
            const dbProducts = document.getElementById('db-products');
            const dbSales = document.getElementById('db-sales');
            const dbUser = document.getElementById('db-user');
            const dbEmail = document.getElementById('db-email');
            
            if (dbStatus) dbStatus.textContent = 'Offline';
            if (dbType) dbType.textContent = 'LocalStorage';
            if (dbProducts) dbProducts.textContent = systemData.products.length;
            if (dbSales) dbSales.textContent = systemData.sales.length;
            if (dbUser) dbUser.textContent = 'Local';
            if (dbEmail) dbEmail.textContent = 'Apenas este dispositivo';
        }
    }

    // ============================================
    // EXPORT/IMPORT FUNCTIONS
    // ============================================

    function exportData(type = 'all') {
        let dataToExport;
        let filename;
        
        switch (type) {
            case 'products':
                dataToExport = {
                    products: systemData.products,
                    exported_at: new Date().toISOString(),
                    type: 'products_only'
                };
                filename = `camarim-produtos-${new Date().toISOString().slice(0,10)}.json`;
                break;
                
            case 'sales':
                dataToExport = {
                    sales: systemData.sales,
                    exported_at: new Date().toISOString(),
                    type: 'sales_only'
                };
                filename = `camarim-vendas-${new Date().toISOString().slice(0,10)}.json`;
                break;
                
            case 'all':
            default:
                dataToExport = {
                    products: systemData.products,
                    sales: systemData.sales,
                    settings: systemData.settings,
                    exported_at: new Date().toISOString(),
                    type: 'complete_backup'
                };
                filename = `camarim-backup-${new Date().toISOString().slice(0,10)}.json`;
                break;
        }
        
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        showAlert(`Backup exportado: ${filename}`, 'success');
    }

    function importData(file) {
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!confirm(`Importar dados? Esta ação irá ${importedData.type === 'complete_backup' ? 'substituir todos os dados atuais' : 'adicionar aos dados existentes'}.`)) {
                    return;
                }
                
                if (importedData.products) {
                    if (importedData.type === 'complete_backup') {
                        systemData.products = importedData.products;
                    } else {
                        // Adicionar produtos sem duplicar IDs
                        const existingIds = new Set(systemData.products.map(p => p.id));
                        importedData.products.forEach(product => {
                            if (!existingIds.has(product.id)) {
                                systemData.products.push(product);
                            }
                        });
                    }
                }
                
                if (importedData.sales) {
                    if (importedData.type === 'complete_backup') {
                        systemData.sales = importedData.sales;
                    } else {
                        // Adicionar vendas sem duplicar IDs
                        const existingIds = new Set(systemData.sales.map(s => s.id));
                        importedData.sales.forEach(sale => {
                            if (!existingIds.has(sale.id)) {
                                systemData.sales.push(sale);
                            }
                        });
                    }
                }
                
                if (importedData.settings && importedData.type === 'complete_backup') {
                    systemData.settings = importedData.settings;
                }
                
                saveData();
                loadData();
                
                showAlert('Dados importados com sucesso!', 'success');
                
            } catch (error) {
                console.error('❌ Erro ao importar dados:', error);
                showAlert('Erro ao importar dados. O arquivo pode estar corrompido.', 'error');
            }
        };
        
        reader.readAsText(file);
        const importFile = document.getElementById('import-file');
        if (importFile) {
            importFile.value = '';
        }
    }

    function clearAllData() {
        if (!confirm('⚠️ ATENÇÃO: Esta ação irá apagar TODOS os dados do sistema. Esta ação não pode ser desfeita. Continuar?')) {
            return;
        }
        
        systemData = {
            products: [],
            sales: [],
            settings: {
                defaultDebitFee: 2.0,
                defaultCreditFee: 4.5,
                defaultTax: 6,
                defaultMargin: 40,
                monthlyOperationalExpenses: 4000,
                lastProductId: 0,
                lastSaleId: 0
            }
        };
        
        localStorage.removeItem('camarim-system-data');
        
        // Limpar caches do Supabase se existirem
        if (supabaseManager.user) {
            localStorage.removeItem(`camarim_cache_products_${supabaseManager.user.id}`);
            localStorage.removeItem(`camarim_cache_sales_${supabaseManager.user.id}`);
        }
        
        loadData();
        showAlert('Todos os dados foram apagados.', 'warning');
    }

    // ============================================
    // ALERT FUNCTIONS
    // ============================================

    function showAlert(message, type = 'success') {
        // Criar elemento de alerta
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${DOMPurify.sanitize(message)}</span>
        `;
        
        // Adicionar ao topo da view atual
        const view = document.querySelector('.view:not(.d-none)');
        if (view) {
            view.prepend(alertDiv);
            
            // Remover após 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    }

    // ============================================
    // CHART FUNCTIONS
    // ============================================

    function updateMonthlySalesChart() {
        const ctx = document.getElementById('monthlySalesChart');
        if (!ctx) return;
        
        // Destruir gráfico existente
        if (appState.charts.monthlySales) {
            appState.charts.monthlySales.destroy();
        }
        
        // Agrupar vendas por mês
        const monthlySales = {};
        systemData.sales.forEach(sale => {
            const date = new Date(sale.date);
            const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
            
            if (!monthlySales[monthYear]) {
                monthlySales[monthYear] = 0;
            }
            
            const total = sale.items?.reduce((sum, item) => sum + (item.total || 0), 0) || 0;
            monthlySales[monthYear] += total;
        });
        
        // Ordenar por data
        const labels = Object.keys(monthlySales).sort((a, b) => {
            const [monthA, yearA] = a.split('/').map(Number);
            const [monthB, yearB] = b.split('/').map(Number);
            return yearA === yearB ? monthA - monthB : yearA - yearB;
        });
        
        const data = labels.map(label => monthlySales[label]);
        
        appState.charts.monthlySales = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Vendas Mensais (R$)',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Vendas: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function updateCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) return;
        
        // Destruir gráfico existente
        if (appState.charts.categoryChart) {
            appState.charts.categoryChart.destroy();
        }
        
        // Agrupar produtos por categoria
        const categoryCount = {};
        systemData.products.forEach(product => {
            const category = product.category || 'outro';
            categoryCount[category] = (categoryCount[category] || 0) + 1;
        });
        
        const labels = Object.keys(categoryCount).map(cat => getCategoryName(cat));
        const data = Object.values(categoryCount);
        
        // Cores para as categorias
        const backgroundColors = [
            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
            '#1abc9c', '#d35400', '#34495e', '#7f8c8d', '#16a085'
        ];
        
        appState.charts.categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} produtos (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ============================================
    // DASHBOARD FUNCTIONS
    // ============================================

    function updateDashboard() {
        if (!appState.databaseReady) return;
        
        // Atualizar resumo de vendas
        updateSalesSummary();
        
        // Atualizar estoque baixo
        updateLowStockAlerts();
        
        // Atualizar últimas vendas
        updateRecentSales();
        
        // Atualizar gráficos
        updateMonthlySalesChart();
        updateCategoryChart();
    }

    function updateSalesSummary() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        
        let todaySales = 0;
        let yesterdaySales = 0;
        let thisMonthSales = 0;
        let lastMonthSales = 0;
        let totalSales = 0;
        
        systemData.sales.forEach(sale => {
            const saleDate = new Date(sale.date);
            const saleTotal = sale.items?.reduce((sum, item) => sum + (item.total || 0), 0) || 0;
            
            totalSales += saleTotal;
            
            if (saleDate >= today) {
                todaySales += saleTotal;
            }
            
            if (saleDate >= yesterday && saleDate < today) {
                yesterdaySales += saleTotal;
            }
            
            if (saleDate >= thisMonth) {
                thisMonthSales += saleTotal;
            }
            
            if (saleDate >= lastMonth && saleDate < thisMonth) {
                lastMonthSales += saleTotal;
            }
        });
        
        // Calcular variações
        const yesterdayChange = yesterdaySales > 0 ? ((todaySales - yesterdaySales) / yesterdaySales * 100) : 0;
        const monthChange = lastMonthSales > 0 ? ((thisMonthSales - lastMonthSales) / lastMonthSales * 100) : 0;
        
        // Atualizar UI
        const todaySalesEl = document.getElementById('today-sales');
        const yesterdaySalesEl = document.getElementById('yesterday-sales');
        const monthSalesEl = document.getElementById('month-sales');
        const totalSalesEl = document.getElementById('total-sales');
        
        if (todaySalesEl) todaySalesEl.textContent = formatCurrency(todaySales);
        if (yesterdaySalesEl) yesterdaySalesEl.textContent = formatCurrency(yesterdaySales);
        if (monthSalesEl) monthSalesEl.textContent = formatCurrency(thisMonthSales);
        if (totalSalesEl) totalSalesEl.textContent = formatCurrency(totalSales);
        
        // Atualizar indicadores de variação
        updateChangeIndicator('today-change', yesterdayChange);
        updateChangeIndicator('month-change', monthChange);
    }

    function updateChangeIndicator(elementId, change) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.textContent = `${change >= 0 ? '+' : ''}${formatNumber(change)}%`;
        element.className = `change-indicator ${change >= 0 ? 'positive' : 'negative'}`;
    }

    function updateLowStockAlerts() {
        const container = document.getElementById('low-stock-alerts');
        if (!container) return;
        
        const lowStockProducts = systemData.products.filter(product => {
            const stock = Number(product.stock) || 0;
            const minStock = Number(product.min_stock) || 0;
            return stock <= minStock && minStock > 0;
        });
        
        if (lowStockProducts.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Todos os produtos estão com estoque adequado.</span>
                </div>
            `;
            return;
        }
        
        let html = '<div class="list-group">';
        lowStockProducts.forEach(product => {
            const stock = Number(product.stock) || 0;
            const minStock = Number(product.min_stock) || 0;
            const percent = minStock > 0 ? Math.round((stock / minStock) * 100) : 0;
            
            html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${DOMPurify.sanitize(product.name)}</strong>
                        <small class="d-block text-muted">${DOMPurify.sanitize(product.sku || 'N/A')}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${percent <= 20 ? 'danger' : percent <= 50 ? 'warning' : 'info'}">
                            ${stock} / ${minStock}
                        </span>
                        <br>
                        <small class="text-muted">${percent}% do mínimo</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    function updateRecentSales() {
        const container = document.getElementById('recent-sales');
        if (!container) return;
        
        const recentSales = systemData.sales.slice(0, 10);
        
        if (recentSales.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Nenhuma venda registrada recentemente.</span>
                </div>
            `;
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += `
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Itens</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
        `;
        
        recentSales.forEach(sale => {
            const total = sale.items?.reduce((sum, item) => sum + (item.total || 0), 0) || 0;
            const itemCount = sale.items?.length || 0;
            
            html += `
                <tr>
                    <td>${formatDate(sale.date)}</td>
                    <td>${DOMPurify.sanitize(sale.customer_name || 'Consumidor Final')}</td>
                    <td>${itemCount} itens</td>
                    <td>${formatCurrency(total)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-info" onclick="viewSaleDetails('${sale.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // ============================================
    // REPORT FUNCTIONS
    // ============================================

    function updateReports() {
        updateSalesReport();
        updateInventoryReport();
        updateFinancialReport();
    }

    function updateSalesReport() {
        // Implementar relatório de vendas detalhado
        console.log('Atualizando relatório de vendas...');
    }

    function updateInventoryReport() {
        // Implementar relatório de inventário
        console.log('Atualizando relatório de inventário...');
    }

    function updateFinancialReport() {
        // Implementar relatório financeiro
        console.log('Atualizando relatório financeiro...');
    }

    // ============================================
    // PRODUCT FUNCTIONS
    // ============================================

    function updateProductsList() {
        const container = document.getElementById('products-list');
        if (!container) return;
        
        const searchTerm = document.getElementById('product-search');
        const categoryFilter = document.getElementById('category-filter');
        
        const searchValue = searchTerm ? searchTerm.value.toLowerCase() : '';
        const categoryValue = categoryFilter ? categoryFilter.value : 'all';
        
        let filteredProducts = systemData.products;
        
        // Aplicar filtros
        if (searchValue) {
            filteredProducts = filteredProducts.filter(product =>
                product.name?.toLowerCase().includes(searchValue) ||
                product.sku?.toLowerCase().includes(searchValue) ||
                product.description?.toLowerCase().includes(searchValue) ||
                product.barcode?.toLowerCase().includes(searchValue)
            );
        }
        
        if (categoryValue && categoryValue !== 'all') {
            filteredProducts = filteredProducts.filter(product =>
                product.category === categoryValue
            );
        }
        
        if (filteredProducts.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Nenhum produto encontrado. ${searchValue || categoryValue !== 'all' ? 'Tente alterar os filtros.' : 'Clique em "Novo Produto" para adicionar.'}</span>
                </div>
            `;
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Custo</th>
                    <th>Preço</th>
                    <th>Estoque</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        filteredProducts.forEach(product => {
            const cost = Number(product.cost) || 0;
            const price = Number(product.price) || 0;
            const stock = Number(product.stock) || 0;
            const minStock = Number(product.min_stock) || 0;
            const margin = price > 0 ? ((price - cost) / price * 100) : 0;
            
            let stockClass = 'success';
            if (stock === 0) stockClass = 'danger';
            else if (stock <= minStock && minStock > 0) stockClass = 'warning';
            
            html += `
                <tr>
                    <td><code>${DOMPurify.sanitize(product.id?.substring(0, 8) || 'N/A')}</code></td>
                    <td>
                        <strong>${DOMPurify.sanitize(product.name || 'N/A')}</strong>
                        ${product.sku ? `<br><small class="text-muted">SKU: ${DOMPurify.sanitize(product.sku)}</small>` : ''}
                    </td>
                    <td>${DOMPurify.sanitize(getCategoryName(product.category || 'outro'))}</td>
                    <td>${formatCurrency(cost)}</td>
                    <td>${formatCurrency(price)}</td>
                    <td>
                        <span class="badge bg-${stockClass}">${stock}</span>
                        ${minStock > 0 ? `<br><small class="text-muted">Mín: ${minStock}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-${margin >= systemData.settings.defaultMargin ? 'success' : 'warning'}">
                            ${formatNumber(margin)}%
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="showProductModal(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="addProductToSale('${product.id}')">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function updateInventorySummary() {
        const container = document.getElementById('inventory-summary');
        if (!container) return;
        
        const totalProducts = systemData.products.length;
        const totalValue = systemData.products.reduce((sum, product) => {
            const cost = Number(product.cost) || 0;
            const stock = Number(product.stock) || 0;
            return sum + (cost * stock);
        }, 0);
        
        const lowStockCount = systemData.products.filter(product => {
            const stock = Number(product.stock) || 0;
            const minStock = Number(product.min_stock) || 0;
            return stock <= minStock && minStock > 0;
        }).length;
        
        const outOfStockCount = systemData.products.filter(product => {
            const stock = Number(product.stock) || 0;
            return stock === 0;
        }).length;
        
        container.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Total Produtos</h6>
                            <h3 class="card-text">${totalProducts}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Valor em Estoque</h6>
                            <h3 class="card-text">${formatCurrency(totalValue)}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h6 class="card-title">Estoque Baixo</h6>
                            <h3 class="card-text">${lowStockCount}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">Fora de Estoque</h6>
                            <h3 class="card-text">${outOfStockCount}</h3>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function saveProduct() {
        const form = document.getElementById('product-form');
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }
        
        const product = {
            id: document.getElementById('product-id').value || null,
            name: document.getElementById('product-name').value.trim(),
            category: document.getElementById('product-category').value,
            cost: sanitizeNumber(document.getElementById('product-cost').value),
            price: sanitizeNumber(document.getElementById('product-price').value),
            stock: sanitizeNumber(document.getElementById('product-stock').value),
            description: document.getElementById('product-description').value.trim(),
            supplier: document.getElementById('product-supplier').value.trim(),
            sku: document.getElementById('product-sku').value.trim(),
            barcode: document.getElementById('product-barcode').value.trim(),
            min_stock: sanitizeNumber(document.getElementById('product-min-stock').value),
            max_stock: sanitizeNumber(document.getElementById('product-max-stock').value),
            location: document.getElementById('product-location').value.trim()
        };
        
        try {
            let result;
            
            if (appState.useSupabase && supabaseManager.user) {
                result = await supabaseManager.saveProduct(product);
            } else {
                // Salvar localmente
                if (!product.id) {
                    product.id = supabaseManager.generateProductId();
                    product.created_at = new Date().toISOString();
                }
                product.updated_at = new Date().toISOString();
                
                const index = systemData.products.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    systemData.products[index] = product;
                } else {
                    systemData.products.unshift(product);
                }
                
                result = { success: true, data: product };
                await saveData();
            }
            
            if (result.success) {
                showAlert('Produto salvo com sucesso!', 'success');
                hideModal('product-modal');
                
                // Atualizar listas
                updateProductsList();
                updateInventorySummary();
                
                if (appState.currentView === 'dashboard') {
                    updateDashboard();
                }
            } else {
                showAlert(`Erro ao salvar produto: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('❌ Erro ao salvar produto:', error);
            showAlert('Erro ao salvar produto. Tente novamente.', 'error');
        }
    }

    async function deleteProduct(productId) {
        if (!confirm('Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita.')) {
            return;
        }
        
        try {
            let result;
            
            if (appState.useSupabase && supabaseManager.user) {
                result = await supabaseManager.deleteProduct(productId);
            } else {
                // Excluir localmente
                systemData.products = systemData.products.filter(p => p.id !== productId);
                result = { success: true };
                await saveData();
            }
            
            if (result.success) {
                showAlert('Produto excluído com sucesso!', 'success');
                
                // Atualizar listas
                updateProductsList();
                updateInventorySummary();
                updateDashboard();
            } else {
                showAlert(`Erro ao excluir produto: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('❌ Erro ao excluir produto:', error);
            showAlert('Erro ao excluir produto. Tente novamente.', 'error');
        }
    }

    // ============================================
    // SALE FUNCTIONS
    // ============================================

    function startNewSale() {
        appState.saleInProgress = true;
        appState.cart = [];
        appState.currentSaleData = null;
        
        // Resetar UI da venda
        const saleItemsList = document.getElementById('sale-items-list');
        if (saleItemsList) {
            saleItemsList.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Nenhum produto adicionado ao carrinho.</span>
                </div>
            `;
        }
        
        const saleTotal = document.getElementById('sale-total');
        if (saleTotal) {
            saleTotal.textContent = 'R$ 0,00';
        }
        
        // Limpar campos do cliente
        const customerName = document.getElementById('customer-name');
        const customerDocument = document.getElementById('customer-document');
        const customerEmail = document.getElementById('customer-email');
        const customerPhone = document.getElementById('customer-phone');
        const paymentMethod = document.getElementById('payment-method');
        const paymentStatus = document.getElementById('payment-status');
        
        if (customerName) customerName.value = '';
        if (customerDocument) customerDocument.value = '';
        if (customerEmail) customerEmail.value = '';
        if (customerPhone) customerPhone.value = '';
        if (paymentMethod) paymentMethod.value = 'dinheiro';
        if (paymentStatus) paymentStatus.value = 'pago';
        
        // Mostrar modal de venda
        showModal('sale-modal');
    }

    function addProductToSale(productId) {
        const product = systemData.products.find(p => p.id === productId);
        if (!product) {
            showAlert('Produto não encontrado!', 'error');
            return;
        }
        
        const stock = Number(product.stock) || 0;
        if (stock <= 0) {
            showAlert('Produto sem estoque disponível!', 'error');
            return;
        }
        
        // Verificar se já está no carrinho
        const existingItem = appState.cart.find(item => item.productId === productId);
        
        if (existingItem) {
            if (existingItem.quantity >= stock) {
                showAlert('Quantidade máxima em estoque atingida!', 'warning');
                return;
            }
            existingItem.quantity++;
            existingItem.total = existingItem.quantity * existingItem.unitPrice;
        } else {
            appState.cart.push({
                productId: productId,
                productName: product.name,
                productSku: product.sku || '',
                unitPrice: Number(product.price) || 0,
                quantity: 1,
                total: Number(product.price) || 0
            });
        }
        
        updateSaleCart();
        showAlert('Produto adicionado ao carrinho!', 'success');
        
        // Se o modal de venda não estiver aberto, abrir
        const saleModal = document.getElementById('sale-modal');
        if (saleModal && !saleModal.classList.contains('show')) {
            showModal('sale-modal');
        }
    }

    function updateSaleCart() {
        const container = document.getElementById('sale-items-list');
        const totalElement = document.getElementById('sale-total');
        
        if (!container || !totalElement) return;
        
        if (appState.cart.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Nenhum produto adicionado ao carrinho.</span>
                </div>
            `;
            totalElement.textContent = 'R$ 0,00';
            return;
        }
        
        let total = 0;
        let html = '<div class="list-group">';
        
        appState.cart.forEach((item, index) => {
            total += item.total;
            
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${DOMPurify.sanitize(item.productName)}</strong>
                        <small class="d-block text-muted">${DOMPurify.sanitize(item.productSku)}</small>
                        <small>${item.quantity} × ${formatCurrency(item.unitPrice)}</small>
                    </div>
                    <div class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="adjustCartQuantity(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="px-2">${item.quantity}</span>
                            <button class="btn btn-outline-secondary" onclick="adjustCartQuantity(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-danger ms-2" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="mt-1">
                            <strong>${formatCurrency(item.total)}</strong>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        totalElement.textContent = formatCurrency(total);
    }

    function adjustCartQuantity(index, change) {
        if (index < 0 || index >= appState.cart.length) return;
        
        const item = appState.cart[index];
        const product = systemData.products.find(p => p.id === item.productId);
        
        if (!product) {
            showAlert('Produto não encontrado!', 'error');
            removeFromCart(index);
            return;
        }
        
        const stock = Number(product.stock) || 0;
        const newQuantity = item.quantity + change;
        
        if (newQuantity < 1) {
            removeFromCart(index);
            return;
        }
        
        if (newQuantity > stock) {
            showAlert('Quantidade máxima em estoque atingida!', 'warning');
            return;
        }
        
        item.quantity = newQuantity;
        item.total = newQuantity * item.unitPrice;
        
        updateSaleCart();
    }

    function removeFromCart(index) {
        if (index >= 0 && index < appState.cart.length) {
            appState.cart.splice(index, 1);
            updateSaleCart();
            showAlert('Item removido do carrinho', 'info');
        }
    }

    async function finalizeSale() {
        if (appState.cart.length === 0) {
            showAlert('Adicione produtos ao carrinho antes de finalizar!', 'error');
            return;
        }
        
        const customerNameEl = document.getElementById('customer-name');
        const customerDocumentEl = document.getElementById('customer-document');
        const customerEmailEl = document.getElementById('customer-email');
        const customerPhoneEl = document.getElementById('customer-phone');
        const paymentMethodEl = document.getElementById('payment-method');
        const paymentStatusEl = document.getElementById('payment-status');
        
        const customerName = customerNameEl ? customerNameEl.value.trim() : 'Consumidor Final';
        const customerDocument = customerDocumentEl ? customerDocumentEl.value.trim() : '';
        const customerEmail = customerEmailEl ? customerEmailEl.value.trim() : '';
        const customerPhone = customerPhoneEl ? customerPhoneEl.value.trim() : '';
        const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'dinheiro';
        const paymentStatus = paymentStatusEl ? paymentStatusEl.value : 'pago';
        
        const total = appState.cart.reduce((sum, item) => sum + item.total, 0);
        
        // Calcular impostos e taxas
        const taxRate = systemData.settings.defaultTax || 6;
        const tax = total * (taxRate / 100);
        
        let feeRate = 0;
        if (paymentMethod === 'debito') {
            feeRate = systemData.settings.defaultDebitFee || 2.0;
        } else if (paymentMethod === 'credito') {
            feeRate = systemData.settings.defaultCreditFee || 4.5;
        }
        const fee = total * (feeRate / 100);
        
        const netTotal = total - tax - fee;
        
        // Criar objeto de venda
        const sale = {
            id: null, // Será gerado pelo saveSale
            date: new Date().toISOString(),
            customer_name: customerName,
            customer_document: customerDocument,
            customer_email: customerEmail,
            customer_phone: customerPhone,
            payment_method: paymentMethod,
            payment_status: paymentStatus,
            items: [...appState.cart],
            subtotal: total,
            tax: tax,
            fee: fee,
            total: total,
            net_total: netTotal,
            notes: ''
        };
        
        try {
            // Salvar venda
            let result;
            
            if (appState.useSupabase && supabaseManager.user) {
                result = await supabaseManager.saveSale(sale);
            } else {
                // Salvar localmente
                sale.id = supabaseManager.generateSaleId();
                
                // Atualizar estoque dos produtos
                sale.items.forEach(item => {
                    const product = systemData.products.find(p => p.id === item.productId);
                    if (product) {
                        product.stock = Math.max(0, (Number(product.stock) || 0) - item.quantity);
                        product.updated_at = new Date().toISOString();
                    }
                });
                
                systemData.sales.unshift(sale);
                result = { success: true, data: sale };
                await saveData();
            }
            
            if (result.success) {
                // Limpar carrinho
                appState.cart = [];
                appState.saleInProgress = false;
                
                // Fechar modal
                hideModal('sale-modal');
                
                // Mostrar recibo
                showReceipt(result.data || sale);
                
                // Atualizar UI
                updateProductsList();
                updateSalesList();
                updateDashboard();
                
                showAlert('Venda realizada com sucesso!', 'success');
            } else {
                showAlert(`Erro ao salvar venda: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('❌ Erro ao finalizar venda:', error);
            showAlert('Erro ao finalizar venda. Tente novamente.', 'error');
        }
    }

    function cancelSale() {
        if (appState.cart.length > 0 && !confirm('Cancelar venda? Todos os itens serão removidos do carrinho.')) {
            return;
        }
        
        appState.cart = [];
        appState.saleInProgress = false;
        hideModal('sale-modal');
        showAlert('Venda cancelada', 'info');
    }

    function showReceipt(sale) {
        // Implementar recibo da venda
        const receiptWindow = window.open('', '_blank');
        receiptWindow.document.write(`
            <html>
            <head>
                <title>Recibo de Venda - ${sale.id}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .receipt { max-width: 400px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                    .item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    .total { font-weight: bold; border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <h2>Sistema Camarim</h2>
                        <p>Recibo de Venda</p>
                        <p>${formatDateTime(sale.date)}</p>
                        <p>ID: ${sale.id}</p>
                    </div>
                    
                    <div>
                        <p><strong>Cliente:</strong> ${sale.customer_name}</p>
                        ${sale.customer_document ? `<p><strong>Documento:</strong> ${sale.customer_document}</p>` : ''}
                        
                        <h4>Itens:</h4>
                        ${sale.items.map(item => `
                            <div class="item">
                                <span>${item.productName} (${item.quantity}x)</span>
                                <span>${formatCurrency(item.total)}</span>
                            </div>
                        `).join('')}
                        
                        <div class="total">
                            <div class="item">
                                <span>Subtotal:</span>
                                <span>${formatCurrency(sale.subtotal)}</span>
                            </div>
                            <div class="item">
                                <span>Taxas:</span>
                                <span>${formatCurrency(sale.tax + sale.fee)}</span>
                            </div>
                            <div class="item">
                                <span>TOTAL:</span>
                                <span>${formatCurrency(sale.total)}</span>
                            </div>
                        </div>
                        
                        <p><strong>Pagamento:</strong> ${sale.payment_method} (${sale.payment_status})</p>
                    </div>
                    
                    <div class="footer">
                        <p>Obrigado pela preferência!</p>
                        <p>Sistema Camarim - ${new Date().getFullYear()}</p>
                    </div>
                </div>
            </body>
            </html>
        `);
        receiptWindow.document.close();
    }

    function updateSalesList() {
        const container = document.getElementById('sales-list');
        if (!container) return;
        
        const dateFilterEl = document.getElementById('sale-date-filter');
        const startDateEl = document.getElementById('start-date');
        const endDateEl = document.getElementById('end-date');
        
        const dateFilter = dateFilterEl ? dateFilterEl.value : 'all';
        const startDate = startDateEl ? startDateEl.value : '';
        const endDate = endDateEl ? endDateEl.value : '';
        
        let filteredSales = systemData.sales;
        
        // Aplicar filtros de data
        if (dateFilter === 'custom' && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            filteredSales = filteredSales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= start && saleDate <= end;
            });
        } else if (dateFilter !== 'all') {
            const now = new Date();
            let start;
            
            switch (dateFilter) {
                case 'today':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'yesterday':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    break;
                case 'this_week':
                    const day = now.getDay();
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
                    break;
                case 'this_month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'last_month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
            }
            
            if (start) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start;
                });
            }
        }
        
        if (filteredSales.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Nenhuma venda encontrada. ${dateFilter !== 'all' ? 'Tente alterar os filtros de data.' : 'Comece fazendo sua primeira venda!'}</span>
                </div>
            `;
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>Data</th>
                    <th>ID Venda</th>
                    <th>Cliente</th>
                    <th>Itens</th>
                    <th>Total</th>
                    <th>Pagamento</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        filteredSales.forEach(sale => {
            const itemCount = sale.items?.length || 0;
            const paymentMethod = sale.payment_method || 'dinheiro';
            const paymentStatus = sale.payment_status || 'pago';
            
            let statusClass = 'success';
            let statusText = 'Pago';
            
            if (paymentStatus === 'pendente') {
                statusClass = 'warning';
                statusText = 'Pendente';
            } else if (paymentStatus === 'cancelado') {
                statusClass = 'danger';
                statusText = 'Cancelado';
            }
            
            html += `
                <tr>
                    <td>${formatDateTime(sale.date)}</td>
                    <td><code>${DOMPurify.sanitize(sale.id?.substring(0, 10) || 'N/A')}</code></td>
                    <td>${DOMPurify.sanitize(sale.customer_name || 'Consumidor Final')}</td>
                    <td>${itemCount} itens</td>
                    <td>${formatCurrency(sale.total || 0)}</td>
                    <td>${DOMPurify.sanitize(paymentMethod)}</td>
                    <td><span class="badge bg-${statusClass}">${DOMPurify.sanitize(statusText)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewSaleDetails('${sale.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="editSale('${sale.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="cancelSaleRecord('${sale.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function viewSaleDetails(saleId) {
        const sale = systemData.sales.find(s => s.id === saleId);
        if (!sale) {
            showAlert('Venda não encontrada!', 'error');
            return;
        }
        
        let details = `
            <h4>Detalhes da Venda: ${sale.id}</h4>
            <p><strong>Data:</strong> ${formatDateTime(sale.date)}</p>
            <p><strong>Cliente:</strong> ${sale.customer_name}</p>
            ${sale.customer_document ? `<p><strong>Documento:</strong> ${sale.customer_document}</p>` : ''}
            ${sale.customer_email ? `<p><strong>Email:</strong> ${sale.customer_email}</p>` : ''}
            ${sale.customer_phone ? `<p><strong>Telefone:</strong> ${sale.customer_phone}</p>` : ''}
            <p><strong>Método de Pagamento:</strong> ${sale.payment_method}</p>
            <p><strong>Status:</strong> ${sale.payment_status}</p>
            
            <h5 class="mt-3">Itens:</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Preço Unit.</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        sale.items?.forEach(item => {
            details += `
                <tr>
                    <td>${item.productName} ${item.productSku ? `(${item.productSku})` : ''}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.total)}</td>
                </tr>
            `;
        });
        
        details += `
                </tbody>
            </table>
            
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Subtotal:</strong> ${formatCurrency(sale.subtotal)}</p>
                    <p><strong>Taxas/Impostos:</strong> ${formatCurrency(sale.tax + sale.fee)}</p>
                    <p><strong>Total:</strong> ${formatCurrency(sale.total)}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Valor Líquido:</strong> ${formatCurrency(sale.net_total)}</p>
                    ${sale.notes ? `<p><strong>Observações:</strong> ${sale.notes}</p>` : ''}
                </div>
            </div>
        `;
        
        // Mostrar em modal
        const modalContent = document.getElementById('sale-details-content');
        if (modalContent) {
            modalContent.innerHTML = details;
            showModal('sale-details-modal');
        } else {
            // Criar modal dinâmico
            const modalHTML = `
                <div class="modal fade show" id="detailsModal" tabindex="-1" style="display: block;">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detalhes da Venda</h5>
                                <button type="button" class="btn-close" onclick="hideModal('detailsModal')"></button>
                            </div>
                            <div class="modal-body">
                                ${details}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="hideModal('detailsModal')">Fechar</button>
                                <button type="button" class="btn btn-primary" onclick="printReceipt('${sale.id}')">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop fade show"></div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
            document.body.style.overflow = 'hidden';
        }
    }

    function editSale(saleId) {
        const sale = systemData.sales.find(s => s.id === saleId);
        if (!sale) {
            showAlert('Venda não encontrada!', 'error');
            return;
        }
        
        // Implementar edição de venda
        showAlert('Edição de vendas será implementada em breve!', 'info');
    }

    function cancelSaleRecord(saleId) {
        if (!confirm('Cancelar esta venda? Esta ação não pode ser desfeita.')) {
            return;
        }
        
        const sale = systemData.sales.find(s => s.id === saleId);
        if (!sale) {
            showAlert('Venda não encontrada!', 'error');
            return;
        }
        
        // Marcar como cancelada
        sale.payment_status = 'cancelado';
        sale.cancelled_at = new Date().toISOString();
        
        // Restaurar estoque dos produtos
        sale.items?.forEach(item => {
            const product = systemData.products.find(p => p.id === item.productId);
            if (product) {
                product.stock = (Number(product.stock) || 0) + item.quantity;
                product.updated_at = new Date().toISOString();
            }
        });
        
        saveData();
        updateSalesList();
        updateProductsList();
        updateDashboard();
        
        showAlert('Venda cancelada com sucesso!', 'success');
    }

    function printReceipt(saleId) {
        const sale = systemData.sales.find(s => s.id === saleId);
        if (!sale) return;
        
        const receiptWindow = window.open('', '_blank');
        receiptWindow.document.write(`
            <html>
            <head>
                <title>Recibo de Venda - ${sale.id}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .receipt { max-width: 400px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                    .item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    .total { font-weight: bold; border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <h2>Sistema Camarim</h2>
                        <p>Recibo de Venda</p>
                        <p>${formatDateTime(sale.date)}</p>
                        <p>ID: ${sale.id}</p>
                        ${sale.cancelled_at ? `<p style="color: red;"><strong>CANCELADA</strong></p>` : ''}
                    </div>
                    
                    <div>
                        <p><strong>Cliente:</strong> ${sale.customer_name}</p>
                        ${sale.customer_document ? `<p><strong>Documento:</strong> ${sale.customer_document}</p>` : ''}
                        
                        <h4>Itens:</h4>
                        ${sale.items.map(item => `
                            <div class="item">
                                <span>${item.productName} (${item.quantity}x)</span>
                                <span>${formatCurrency(item.total)}</span>
                            </div>
                        `).join('')}
                        
                        <div class="total">
                            <div class="item">
                                <span>Subtotal:</span>
                                <span>${formatCurrency(sale.subtotal)}</span>
                            </div>
                            <div class="item">
                                <span>Taxas:</span>
                                <span>${formatCurrency(sale.tax + sale.fee)}</span>
                            </div>
                            <div class="item">
                                <span>TOTAL:</span>
                                <span>${formatCurrency(sale.total)}</span>
                            </div>
                        </div>
                        
                        <p><strong>Pagamento:</strong> ${sale.payment_method} (${sale.payment_status})</p>
                        ${sale.cancelled_at ? `<p><strong>Cancelada em:</strong> ${formatDateTime(sale.cancelled_at)}</p>` : ''}
                    </div>
                    
                    <div class="footer">
                        <p>Obrigado pela preferência!</p>
                        <p>Sistema Camarim - ${new Date().getFullYear()}</p>
                    </div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 20px;">
                    <button onclick="window.print()">Imprimir</button>
                    <button onclick="window.close()">Fechar</button>
                </div>
            </body>
            </html>
        `);
        receiptWindow.document.close();
    }

    // ============================================
    // SETTINGS FUNCTIONS
    // ============================================

    function loadSettingsToForm() {
        const settings = systemData.settings;
        
        const debitFee = document.getElementById('default-debit-fee');
        const creditFee = document.getElementById('default-credit-fee');
        const tax = document.getElementById('default-tax');
        const margin = document.getElementById('default-margin');
        const expenses = document.getElementById('monthly-expenses');
        
        if (debitFee) debitFee.value = settings.defaultDebitFee || 2.0;
        if (creditFee) creditFee.value = settings.defaultCreditFee || 4.5;
        if (tax) tax.value = settings.defaultTax || 6;
        if (margin) margin.value = settings.defaultMargin || 40;
        if (expenses) expenses.value = settings.monthlyOperationalExpenses || 4000;
    }

    async function saveSettings() {
        const debitFee = document.getElementById('default-debit-fee');
        const creditFee = document.getElementById('default-credit-fee');
        const tax = document.getElementById('default-tax');
        const margin = document.getElementById('default-margin');
        const expenses = document.getElementById('monthly-expenses');
        
        if (!debitFee || !creditFee || !tax || !margin || !expenses) return;
        
        const settings = {
            defaultDebitFee: sanitizeNumber(debitFee.value),
            defaultCreditFee: sanitizeNumber(creditFee.value),
            defaultTax: sanitizeNumber(tax.value),
            defaultMargin: sanitizeNumber(margin.value),
            monthlyOperationalExpenses: sanitizeNumber(expenses.value)
        };
        
        try {
            let result;
            
            if (appState.useSupabase && supabaseManager.user) {
                result = await supabaseManager.saveSettings(settings);
            } else {
                // Salvar localmente
                systemData.settings = { ...systemData.settings, ...settings };
                result = { success: true };
                await saveData();
            }
            
            if (result.success) {
                showAlert('Configurações salvas com sucesso!', 'success');
            } else {
                showAlert(`Erro ao salvar configurações: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('❌ Erro ao salvar configurações:', error);
            showAlert('Erro ao salvar configurações. Tente novamente.', 'error');
        }
    }

    // ============================================
    // SETUP EVENT LISTENERS COMPLETO
    // ============================================

    function setupEventListeners() {
        // Event listeners para navegação
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const viewName = this.getAttribute('href').substring(1);
                window.location.hash = viewName;
                showView(viewName);
            });
        });
        
        // Botão de novo produto
        const newProductBtn = document.getElementById('new-product-btn');
        if (newProductBtn) {
            newProductBtn.addEventListener('click', function() {
                showProductModal();
            });
        }
        
        // Botão de nova venda
        const newSaleBtn = document.getElementById('new-sale-btn');
        if (newSaleBtn) {
            newSaleBtn.addEventListener('click', function() {
                startNewSale();
            });
        }
        
        // Botão de salvar configurações
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', function() {
                saveSettings();
            });
        }
        
        // Botão de importar dados
        const importDataBtn = document.getElementById('import-data-btn');
        if (importDataBtn) {
            importDataBtn.addEventListener('click', function() {
                const importFile = document.getElementById('import-file');
                if (importFile) {
                    importFile.click();
                }
            });
        }
        
        const importFile = document.getElementById('import-file');
        if (importFile) {
            importFile.addEventListener('change', function(e) {
                importData(e.target.files[0]);
            });
        }
        
        // Botão de exportar dados
        const exportDataBtn = document.getElementById('export-data-btn');
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', function() {
                exportData('all');
            });
        }
        
        // Botão de backup produtos
        const exportProductsBtn = document.getElementById('export-products-btn');
        if (exportProductsBtn) {
            exportProductsBtn.addEventListener('click', function() {
                exportData('products');
            });
        }
        
        // Botão de backup vendas
        const exportSalesBtn = document.getElementById('export-sales-btn');
        if (exportSalesBtn) {
            exportSalesBtn.addEventListener('click', function() {
                exportData('sales');
            });
        }
        
        // Botão limpar dados
        const clearDataBtn = document.getElementById('clear-data-btn');
        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', function() {
                clearAllData();
            });
        }
        
        // Botão fechar modal de produto
        const closeProductModal = document.getElementById('close-product-modal');
        if (closeProductModal) {
            closeProductModal.addEventListener('click', function() {
                hideModal('product-modal');
            });
        }
        
        // Botão salvar produto
        const saveProductBtn = document.getElementById('save-product-btn');
        if (saveProductBtn) {
            saveProductBtn.addEventListener('click', function() {
                saveProduct();
            });
        }
        
        // Botão cancelar produto
        const cancelProductBtn = document.getElementById('cancel-product-btn');
        if (cancelProductBtn) {
            cancelProductBtn.addEventListener('click', function() {
                hideModal('product-modal');
            });
        }
        
        // Botão excluir produto
        const deleteProductBtn = document.getElementById('delete-product-btn');
        if (deleteProductBtn) {
            deleteProductBtn.addEventListener('click', function() {
                if (appState.currentProductId) {
                    deleteProduct(appState.currentProductId);
                }
            });
        }
        
        // Botões da venda
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', function() {
                addToCart();
            });
        }
        
        const finalizeSaleBtn = document.getElementById('finalize-sale-btn');
        if (finalizeSaleBtn) {
            finalizeSaleBtn.addEventListener('click', function() {
                finalizeSale();
            });
        }
        
        const cancelSaleBtn = document.getElementById('cancel-sale-btn');
        if (cancelSaleBtn) {
            cancelSaleBtn.addEventListener('click', function() {
                cancelSale();
            });
        }
        
        // Botão de migração
        const migrateBtn = document.getElementById('migrate-local-data');
        if (migrateBtn) {
            migrateBtn.addEventListener('click', async () => {
                if (!supabaseManager.user) {
                    showAlert('Faça login na nuvem primeiro', 'error');
                    return;
                }
                
                if (confirm('Migrar todos os dados locais para a nuvem? Esta ação não pode ser desfeita.')) {
                    const result = await supabaseManager.migrateLocalData();
                    if (result.success) {
                        // Recarregar dados da nuvem
                        await initSystem();
                        updateDatabaseInfo();
                        updateProductsList();
                        updateSalesList();
                        updateDashboard();
                    }
                }
            });
        }
        
        // Botão de sincronização offline
        const syncBtn = document.getElementById('sync-offline-data');
        if (!syncBtn) {
            // Adicionar botão se não existir
            const actionsDiv = document.querySelector('.products-actions .right-actions');
            if (actionsDiv) {
                const syncButton = document.createElement('button');
                syncButton.className = 'btn btn-info';
                syncButton.id = 'sync-offline-data';
                syncButton.innerHTML = '<i class="fas fa-sync"></i> Sincronizar';
                syncButton.title = 'Sincronizar dados offline com a nuvem';
                actionsDiv.prepend(syncButton);
                
                syncButton.addEventListener('click', async () => {
                    if (!supabaseManager.user) {
                        showAlert('Faça login na nuvem primeiro', 'error');
                        return;
                    }
                    
                    const result = await supabaseManager.syncOfflineData();
                    if (result.success && result.syncedProducts + result.syncedSales > 0) {
                        // Recarregar dados
                        await initSystem();
                        updateProductsList();
                        updateSalesList();
                        updateDashboard();
                    }
                });
            }
        }
        
        // Botão de exportação da nuvem
        const exportDbBtn = document.getElementById('export-db');
        if (exportDbBtn) {
            exportDbBtn.addEventListener('click', async () => {
                if (appState.useSupabase && supabaseManager.user) {
                    const result = await supabaseManager.exportAllData();
                    if (result.success) {
                        const dataStr = JSON.stringify(result.data, null, 2);
                        const blob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `camarim-backup-${new Date().toISOString().slice(0,10)}.json`;
                        link.click();
                        
                        URL.revokeObjectURL(url);
                        
                        showAlert('Backup exportado com sucesso!', 'success');
                    }
                } else {
                    // Exportação local
                    exportData('all');
                }
            });
        }
        
        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl+N para novo produto
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                showProductModal();
            }
            
            // Ctrl+S para nova venda
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                startNewSale();
            }
            
            // Esc para fechar modal
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    hideModal(modal.id);
                }
            }
        });
        
        // Mudança de filtros
        const productSearch = document.getElementById('product-search');
        if (productSearch) {
            productSearch.addEventListener('input', function() {
                updateProductsList();
            });
        }
        
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                updateProductsList();
            });
        }
        
        const saleDateFilter = document.getElementById('sale-date-filter');
        if (saleDateFilter) {
            saleDateFilter.addEventListener('change', function() {
                updateSalesList();
            });
        }
        
        // Filtro de vendas por data
        const startDate = document.getElementById('start-date');
        if (startDate) {
            startDate.addEventListener('change', function() {
                updateSalesList();
            });
        }
        
        const endDate = document.getElementById('end-date');
        if (endDate) {
            endDate.addEventListener('change', function() {
                updateSalesList();
            });
        }
    }

    // ============================================
    // INICIALIZAÇÃO COMPLETA
    // ============================================

    document.addEventListener('DOMContentLoaded', function() {
        initializeSystem();
        
        // Hash change para navegação
        window.addEventListener('hashchange', checkHashAndShowView);
        
        // Inicializar gráficos se Chart.js estiver disponível
        if (typeof Chart !== 'undefined') {
            console.log('📊 Chart.js disponível');
        }
    });

</script>

</body>
</html>
